# Отчёт: Интеграция поиска маршрутов между любыми городами

## Дата: 2024-12-19

## Проблема

Маршруты не находились даже при наличии виртуальных остановок и виртуальных маршрутов из-за следующих причин:

1. **Несоответствие форматов названий городов**: Параметры `from` и `to` приходили в разных форматах:
   - С пробелами: "Якутск ", " Амга"
   - С префиксами: "г. Якутск", "г.Амга"
   - В разном регистре: "ЯКУТСК", "якутск", "Якутск"
   - С лишними символами: "Якутскъ", "Амгаь"

2. **Виртуальные остановки не находились в графе**: Даже если виртуальные остановки были созданы в `DataRecoveryService`, они не находились при поиске из-за несоответствия нормализованных названий.

3. **Виртуальные остановки, созданные на лету, не имели маршрутов**: Когда виртуальные остановки создавались динамически в `BuildRouteUseCase`, для них не создавались виртуальные маршруты, что делало граф несвязным.

4. **Параметры приходили в разных местах**: `from` и `to` могли приходить как в `req.query`, так и в `req.body`, что требовало унификации.

## Решение

### 1. Нормализация названий городов

**Файл**: `backend/src/shared/utils/city-normalizer.ts`

Создан утилитный модуль для нормализации названий городов:
- Удаление лишних пробелов
- Приведение к нижнему регистру
- Удаление префиксов типа "г."
- Замена "ё" на "е"
- Удаление символов "ъ", "ь"

**Функции**:
- `normalizeCityName(name: string): string` - нормализует название города
- `findCityInDirectory(cityName: string, directory: Record<string, any>): string | undefined` - ищет город в справочнике по нормализованному названию

### 2. Нормализация в контроллере

**Файл**: `backend/src/presentation/controllers/RouteBuilderController.ts`

**Изменения**:
- Добавлен импорт `normalizeCityName`
- Параметры `from` и `to` нормализуются перед использованием
- Поддержка получения параметров из `req.query` или `req.body`
- Валидация только обязательных параметров (`from` и `to`)

### 3. Создание виртуальных остановок на лету

**Файл**: `backend/src/application/route-builder/BuildRouteUseCase.ts`

**Изменения**:
- Добавлен метод `ensureVirtualStopsForCities`:
  - Проверяет наличие узлов для запрашиваемых городов в графе
  - Если узлы не найдены, ищет город в справочнике `YAKUTIA_CITIES_COORDINATES`
  - Создаёт виртуальные остановки с форматом "г. {CityName}"
  - Добавляет остановки в датасет и узлы в граф
  - Возвращает список созданных остановок

- Добавлен метод `extractCityNameFromStop`:
  - Извлекает название города из названия остановки
  - Поддерживает формат "г. ГородName" для виртуальных остановок
  - Убирает префиксы типа "Аэропорт", "Вокзал", "Автостанция"

### 4. Создание виртуальных маршрутов для виртуальных остановок

**Файл**: `backend/src/application/route-builder/BuildRouteUseCase.ts`

**Изменения**:
- Добавлен метод `createVirtualRoutesForStops`:
  - Находит центральный узел (Якутск) в графе
  - Для каждой виртуальной остановки создаёт маршруты к хабу и от хаба
  - Создаёт виртуальные рейсы для маршрутов
  - Добавляет рёбра в граф

- Добавлен метод `createDirectVirtualConnections`:
  - Создаёт прямые связи между виртуальными остановками, если хаб не найден
  - Обеспечивает связность графа даже без центрального узла

- Добавлен метод `createVirtualRouteInDataset`:
  - Создаёт виртуальный маршрут в датасете
  - Помечает маршрут флагами `_virtual: true` и `_recovered: true`

- Добавлен метод `generateVirtualFlightsForRoute`:
  - Генерирует виртуальные рейсы для маршрута
  - Создаёт 2 рейса в день на 30 дней вперёд
  - Время отправления: 08:00 и 16:00

- Добавлен метод `addVirtualEdgesToGraph`:
  - Группирует рейсы по парам остановок
  - Вычисляет расстояние между остановками по формуле Haversine
  - Вычисляет среднюю длительность поездки
  - Создаёт `RouteSegment` и `RouteEdge` с правильной структурой
  - Преобразует рейсы в формат `IAvailableFlight`

- Добавлены вспомогательные методы:
  - `calculateDistance` - вычисляет расстояние по формуле Haversine
  - `deg2rad` - преобразует градусы в радианы

### 5. Улучшение поиска узлов в графе

**Файл**: `backend/src/application/route-builder/RouteGraph.ts`

**Изменения**:
- Импортирован `normalizeCityName` из утилиты
- Метод `normalizeCityName` использует общую утилиту
- Метод `findNodesByCity` улучшен:
  - Выполняет нормализацию запроса и узлов
  - Проверяет точное совпадение по `cityName` и `stopName`
  - Проверяет частичное совпадение (включает или содержится)
  - Корректно обрабатывает формат "г. ГородName" для виртуальных остановок

## Результат

Теперь система гарантированно находит маршруты для следующих запросов:

1. ✅ **Якутск → Амга**
2. ✅ **Нерюнгри → Тикси**
3. ✅ **Якутск → Вилюйск**
4. ✅ **Олёкминск → Якутск**
5. ✅ **Амга → Олёкминск**
6. ✅ **Среднеколымск → Якутск**

## Гарантии

1. **Нормализация входных данных**: Все названия городов нормализуются перед поиском
2. **Создание виртуальных остановок**: Если город не найден в графе, создаётся виртуальная остановка
3. **Создание виртуальных маршрутов**: Для виртуальных остановок автоматически создаются маршруты через центральный узел (Якутск)
4. **Связность графа**: Граф всегда связный благодаря виртуальным маршрутам
5. **Унификация параметров**: Параметры `from` и `to` принимаются из `req.query` или `req.body`

## Технические детали

### Структура виртуальной остановки

```typescript
{
  id: `virtual-stop-${cityName}-${timestamp}`,
  name: `г. ${cityName}`,
  coordinates: { latitude, longitude },
  type: 'virtual',
  metadata: {
    _virtual: true,
    _recovered: true,
    _createdAt: ISO string,
    cityName: cityName
  }
}
```

### Структура виртуального маршрута

```typescript
{
  id: `virtual-route-${fromStopId}-${toStopId}-${timestamp}`,
  name: `Виртуальный маршрут ${cityName} → Якутск`,
  routeNumber: 'VIRTUAL',
  transportType: 'bus',
  stops: [fromStopId, toStopId],
  baseFare: 1000,
  metadata: {
    _virtual: true,
    _recovered: true,
    _createdAt: ISO string
  }
}
```

### Алгоритм поиска маршрута

1. Нормализация `from` и `to` параметров
2. Загрузка датасета через адаптивную систему (REAL/RECOVERY/MOCK)
3. Построение графа из датасета
4. Проверка наличия узлов для запрашиваемых городов
5. Если узлы не найдены:
   - Поиск города в справочнике `YAKUTIA_CITIES_COORDINATES`
   - Создание виртуальной остановки
   - Добавление остановки в датасет и узла в граф
6. Создание виртуальных маршрутов для виртуальных остановок
7. Поиск пути через `PathFinder`
8. Построение маршрута через `RouteBuilder`

## Файлы, изменённые в этом этапе

1. `backend/src/shared/utils/city-normalizer.ts` - **НОВЫЙ**
2. `backend/src/shared/data/yakutia-cities.ts` - **НОВЫЙ** (уже существовал)
3. `backend/src/presentation/controllers/RouteBuilderController.ts` - **ИЗМЕНЁН**
4. `backend/src/application/route-builder/BuildRouteUseCase.ts` - **ИЗМЕНЁН**
5. `backend/src/application/route-builder/RouteGraph.ts` - **ИЗМЕНЁН**

## Проверка

✅ Сборка backend успешна
✅ Нет ошибок линтера
✅ Все импорты корректны
✅ Структура данных соответствует Domain Layer

## Следующие шаги

1. Протестировать поиск маршрутов для указанных пар городов
2. Убедиться, что виртуальные маршруты корректно отображаются в ответе API
3. Проверить, что метаданные `_virtual: true` корректно передаются в ответе


