# Детальный аудит навигации и формирования URL в модуле маршрутов

## Резюме

**Проблема:** Проверка всех мест, где происходит формирование URL для навигации, чтобы найти возможную подмену API запроса на переход к странице `/routes`.

**Вывод:** **Подмены API запроса на навигацию НЕ обнаружено.** Все вызовы `router.push` и `Link` ведут на страницы Next.js, а API запросы выполняются через `fetchApi`. Однако обнаружен **потенциальный конфликт имён** между страницей `/routes` и API `/api/v1/routes/search`, который может вызывать путаницу в логах и отладке.

---

## Шаг 1. Все вызовы router.push, router.replace, router.prefetch

### Найденные вызовы:

#### 1. `router.push` в `search-form.tsx`

**Файл:** `frontend/src/modules/routes/features/route-search/ui/search-form.tsx`

**Строка 89:**
```typescript
router.push(`/routes?${params.toString()}`)
```

**Анализ:**
- **URL:** `/routes?from=Якутск&to=Мирный&date=2025-01-15&passengers=1`
- **Параметры:** `from`, `to`, `date` (опционально), `passengers` (опционально)
- **Назначение:** Переход на страницу результатов поиска после отправки формы
- **Формирование:** Параметры собираются из валидированных данных формы через `URLSearchParams`

**Вывод:** ✅ Корректный переход на страницу `/routes` с параметрами поиска.

#### 2. `router.push` в `routes/page.tsx`

**Файл:** `frontend/src/app/routes/page.tsx`

**Строка 76:**
```typescript
router.push(`/routes/details?routeId=${route.routeId}`)
```

**Анализ:**
- **URL:** `/routes/details?routeId=route-Якутск-Мирный-0-1234567890`
- **Параметры:** `routeId`
- **Назначение:** Переход на страницу детальной информации о маршруте
- **Контекст:** Вызывается при клике на кнопку "Выбрать маршрут"

**Вывод:** ✅ Корректный переход на страницу деталей маршрута.

#### 3. `router.push` в `error-fallback.tsx`

**Файл:** `frontend/src/shared/ui/error-boundary/error-fallback.tsx`

**Строка 15:**
```typescript
router.push('/')
```

**Анализ:**
- **URL:** `/`
- **Параметры:** Нет
- **Назначение:** Возврат на главную страницу при ошибке в Error Boundary
- **Контекст:** Вызывается при нажатии кнопки "Вернуться на главную"

**Вывод:** ✅ Корректный переход на главную страницу.

### Случаи, где URL начинается с `/routes`:

| Файл | Строка | URL | Тип | Назначение |
|------|--------|-----|-----|------------|
| `search-form.tsx` | 89 | `/routes?params` | `router.push` | Переход на страницу результатов |
| `routes/page.tsx` | 76 | `/routes/details?routeId=...` | `router.push` | Переход на страницу деталей |

**Вывод:** Все вызовы `router.push` с `/routes` ведут на страницы Next.js, а не на API.

---

## Шаг 2. Все ссылки (`<Link href="...">`) и переходы

### Найденные ссылки:

#### 1. `BrandLogo` компонент

**Файл:** `frontend/src/shared/ui/brand-logo/brand-logo.tsx`

**Строка 55:**
```typescript
href="/"
```

**Анализ:**
- **URL:** `/`
- **Назначение:** Ссылка на главную страницу в логотипе

**Вывод:** ✅ Не связана с маршрутами.

#### 2. Ссылки в `Footer`

**Файл:** `frontend/src/shared/ui/footer/footer.tsx`

**Строки 27, 43:**
```typescript
href="/about"
href="/license"
```

**Анализ:**
- **URL:** `/about`, `/license`
- **Назначение:** Ссылки на страницы "О нас" и "Документы"

**Вывод:** ✅ Не связаны с маршрутами.

#### 3. Ссылки в `Header`

**Файл:** `frontend/src/shared/ui/header/header.tsx`

**Строки 27, 35:**
```typescript
href="/profile"
href="/settings"
```

**Анализ:**
- **URL:** `/profile`, `/settings`
- **Назначение:** Ссылки на страницы профиля и настроек

**Вывод:** ✅ Не связаны с маршрутами.

### Случаи, где путь совпадает с API-роутом по имени:

**НЕ обнаружено.** Все ссылки ведут на страницы Next.js, а не на API endpoints.

---

## Шаг 3. Проверка директории `app/routes/`

### Структура директории:

```
frontend/src/app/routes/
├── details/
│   ├── layout.tsx
│   └── page.tsx
├── layout.tsx
├── page.test.tsx
└── page.tsx
```

### Анализ файлов:

#### 1. `app/routes/page.tsx`

**Файл:** `frontend/src/app/routes/page.tsx`

**Строки 24-30:**
```typescript
const searchParams = useSearchParams()
const router = useRouter()

const from = searchParams.get('from') || ''
const to = searchParams.get('to') || ''
const date = searchParams.get('date') || ''
const passengers = searchParams.get('passengers') || '1'
```

**Анализ параметров:**
- **`from`:** Может быть пустой строкой `''`, если параметр отсутствует в URL
- **`to`:** Может быть пустой строкой `''`, если параметр отсутствует в URL
- **`date`:** Может быть пустой строкой `''`, если параметр отсутствует в URL
- **`passengers`:** По умолчанию `'1'`, но может быть любым значением из URL

**Строка 32:**
```typescript
const { routes, alternatives, isLoading, error, errorCode } = useRoutesSearch({
  from,
  to,
  date,
  passengers,
})
```

**Анализ:**
- Параметры передаются в `useRoutesSearch` без валидации
- Если `from` или `to` пустые, `useRoutesSearch` не выполнит запрос (`enabled: Boolean(normalizedFrom && normalizedTo)`)

**Строка 40:**
```typescript
const hasRequiredParams = Boolean(from && to)
```

**Анализ:**
- Проверка наличия обязательных параметров
- Если параметры отсутствуют, показывается сообщение "Не указаны параметры поиска"

#### 2. `app/routes/layout.tsx`

**Файл:** `frontend/src/app/routes/layout.tsx`

**Анализ:**
- Простой layout без логики
- Не содержит редиректов или проверок параметров

#### 3. `app/routes/details/page.tsx`

**Файл:** `frontend/src/app/routes/details/page.tsx`

**Строка 25:**
```typescript
const searchParams = useSearchParams();
```

**Анализ:**
- Читает параметр `routeId` из URL
- Загружает данные маршрута из `localStorage`
- Не связан с API запросами поиска

### Конфликт между названием страницы `/routes` и API `/routes/search`:

**Обнаружен потенциальный конфликт имён:**

1. **Страница Next.js:** `/routes` — обрабатывает навигацию и рендеринг страницы
2. **API endpoint:** `/api/v1/routes/search` — обрабатывает HTTP запросы поиска маршрутов

**Анализ конфликта:**
- Next.js **НЕ перехватывает** API запросы — `fetch()` и `fetchApi()` делают HTTP запросы, а не навигацию
- Конфликт может возникнуть только в логах или отладке, где пути могут выглядеть похоже
- В коде конфликта нет — страница и API используют разные протоколы (навигация vs HTTP)

**Вывод:** Конфликт имён существует, но не влияет на функциональность, так как Next.js различает навигацию и HTTP запросы.

---

## Шаг 4. Функции, формирующие URL строки браузера

### Найденные функции:

#### 1. Формирование URL в `search-form.tsx`

**Файл:** `frontend/src/modules/routes/features/route-search/ui/search-form.tsx`

**Строки 72-89:**
```typescript
// Формируем параметры для URL
const params = new URLSearchParams({
  from: validatedData.from,
  to: validatedData.to,
})

// Добавляем дату, если она указана
if (validatedData.date) {
  params.set('date', validatedData.date)
}

// Добавляем количество пассажиров, если указано
if (validatedData.passengers) {
  params.set('passengers', validatedData.passengers)
}

// Переход на страницу результатов поиска
router.push(`/routes?${params.toString()}`)
```

**Анализ:**
- **Где URL собирается:** Строки 73-86
- **Формат:** `/routes?from=Якутск&to=Мирный&date=2025-01-15&passengers=1`
- **Может ли пропасть дата:** ✅ Да, если `validatedData.date` отсутствует или `undefined`, дата не добавляется в URL
- **Может ли произойти двойной вызов `router.push`:** ❌ Нет — вызов происходит один раз после валидации

**Вывод:** URL формируется корректно, дата добавляется только если указана.

#### 2. Чтение параметров в `routes/page.tsx`

**Файл:** `frontend/src/app/routes/page.tsx`

**Строки 27-30:**
```typescript
const from = searchParams.get('from') || ''
const to = searchParams.get('to') || ''
const date = searchParams.get('date') || ''
const passengers = searchParams.get('passengers') || '1'
```

**Анализ:**
- **Где URL читается:** Строки 27-30
- **Могут ли параметры быть пустыми:** ✅ Да, если параметры отсутствуют в URL, возвращаются пустые строки или значения по умолчанию
- **Влияние на API запрос:** Если `from` или `to` пустые, `useRoutesSearch` не выполнит запрос (`enabled: false`)

**Вывод:** Параметры читаются корректно, но пустые значения могут блокировать API запрос.

---

## Шаг 5. Проверка `fetchApi` на предмет использования `window.location`

### Файл: `frontend/src/shared/utils/api.ts`

**Проверка на использование `window.location`:**

**Результат:** ❌ `fetchApi` **НЕ использует** `window.location` для формирования URL.

**Строка 17:**
```typescript
const url = `${API_BASE_URL}${endpoint}`;
```

**Анализ:**
- URL формируется из `API_BASE_URL` и `endpoint`
- Не использует `window.location`
- Не делает навигацию

### Проверка на подмену API-запросов на client-side навигацию:

**Результат:** ❌ **НЕ обнаружено** функций, которые подменяют API-запросы на навигацию.

### Проверка на проверки типа `if (window.location.pathname.includes("routes"))`:

**Результат:** ❌ **НЕ обнаружено** таких проверок в коде.

### Проверка на перехват ошибок, который вызывает `router.push` внутри `catch`:

**Результат:** ❌ **НЕ обнаружено** вызовов `router.push` в `catch` блоках, связанных с API запросами.

**Найденные `catch` блоки:**
- `use-routes-search.ts` (строки 130, 199, 215): Обработка ошибок API, но без навигации
- `api.ts` (строки 43, 55): Обработка ошибок сети, но без навигации
- `search-form.tsx` (строка 92): Обработка ошибок валидации, но без навигации

**Вывод:** `fetchApi` не использует `window.location` и не вызывает навигацию.

---

## Шаг 6. Конфликты имён между страницами и API

### Обнаруженные конфликты:

#### Конфликт 1: `/routes` (страница) vs `/api/v1/routes/search` (API)

**Страница Next.js:**
- **Путь:** `/routes`
- **Файл:** `frontend/src/app/routes/page.tsx`
- **Назначение:** Отображение результатов поиска маршрутов
- **Тип:** Client-side навигация (рендеринг страницы)

**API endpoint:**
- **Путь:** `/api/v1/routes/search`
- **Файл:** `frontend/src/modules/routes/hooks/use-routes-search.ts` (строка 118)
- **Назначение:** HTTP запрос для поиска маршрутов
- **Тип:** HTTP API запрос

**Анализ конфликта:**
- **Может ли Next.js перепутать:** ❌ Нет — Next.js различает навигацию и HTTP запросы
- **Может ли браузер перепутать:** ❌ Нет — `fetch()` делает HTTP запрос, а не навигацию
- **Где может возникнуть путаница:**
  1. В логах backend (может логировать только путь без префикса)
  2. В DevTools (может показывать относительный путь)
  3. В отладке (пути выглядят похоже)

**Вывод:** Конфликт имён существует, но не влияет на функциональность.

---

## Шаг 7. Точка подмены API на страницу

### Таблица анализа:

| Место в коде | Ожидаемый URL | Фактическое влияние | Почему вызывает переход на страницу | Статус |
|--------------|---------------|---------------------|-------------------------------------|--------|
| `search-form.tsx:89` | `/routes?params` | Переход на страницу результатов | `router.push()` делает навигацию, а не API запрос | ✅ Корректно |
| `routes/page.tsx:32` | API: `/api/v1/routes/search` | Вызов API через `useRoutesSearch` | `fetchApi()` делает HTTP запрос | ✅ Корректно |
| `routes/page.tsx:76` | `/routes/details?routeId=...` | Переход на страницу деталей | `router.push()` делает навигацию | ✅ Корректно |

### Вывод:

**Подмены API на страницу НЕ обнаружено.** Все вызовы работают корректно:
- `router.push()` — для навигации по страницам
- `fetchApi()` — для API запросов

---

## Шаг 8. Финальное резюме

### Где именно вызывается `router.push("/routes?...")`?

**Ответ:** В файле `frontend/src/modules/routes/features/route-search/ui/search-form.tsx`, строка 89.

**Контекст:**
```typescript
router.push(`/routes?${params.toString()}`)
```

**Назначение:** Переход на страницу результатов поиска после отправки формы поиска маршрутов.

**Параметры:** `from`, `to`, `date` (опционально), `passengers` (опционально)

### Где формируется URL страницы вместо API?

**Ответ:** URL страницы формируется в `search-form.tsx` (строки 72-89), а API запрос формируется в `use-routes-search.ts` (строка 118). Это **разные процессы**:
- URL страницы: для навигации Next.js
- API URL: для HTTP запроса к backend

**Подмены не происходит** — это два разных механизма.

### Где Next.js перехватывает маршрут?

**Ответ:** Next.js **НЕ перехватывает** API запросы. Next.js обрабатывает только:
- Навигацию через `router.push()`, `<Link>`, прямой ввод URL в браузере
- Рендеринг страниц по маршрутам `/routes`, `/routes/details` и т.д.

**API запросы через `fetch()` и `fetchApi()` НЕ перехватываются** Next.js и идут напрямую к backend.

### Почему UI показывает "Не удалось подключиться"?

**Ответ:** UI показывает "Не удалось подключиться к серверу" в следующих случаях:

1. **Сетевая ошибка** (файл `api.ts`, строка 62):
   ```typescript
   if (error instanceof Error && error.message.includes('Failed to fetch')) {
     throw new Error(`Не удалось подключиться к серверу. Проверьте, что backend запущен на ${API_BASE_URL.replace('/api/v1', '')}`);
   }
   ```

2. **Backend недоступен** (CORS, сеть, сервер не запущен)

3. **Ошибка без специфического кода** (файл `routes/page.tsx`, строка 67):
   ```typescript
   return error.message || 'Произошла ошибка при поиске маршрутов'
   ```

**Это НЕ связано с подменой API на страницу** — это нормальная обработка ошибок сети/API.

### Какие строки ответственны за перехват?

**Ответ:** **Перехвата не происходит.** Все работает корректно:
- Навигация: `search-form.tsx:89` → `router.push('/routes?params')` → страница `/routes`
- API запрос: `use-routes-search.ts:118` → `fetchApi('/routes/search?params')` → API `/api/v1/routes/search`

**Нет строк, которые перехватывают API запрос и превращают его в навигацию.**

---

## Итоговый вывод

### Основные находки:

1. **Подмены API на страницу НЕ обнаружено** — все работает корректно
2. **Конфликт имён существует** (`/routes` страница vs `/api/v1/routes/search` API), но не влияет на функциональность
3. **Все вызовы `router.push` ведут на страницы Next.js**, а не на API
4. **API запросы выполняются через `fetchApi`**, который не использует навигацию

### Рекомендации:

1. **Если запрос действительно уходит на `/routes` вместо `/api/v1/routes/search`:**
   - Проверить фактический запрос в Network tab браузера
   - Проверить логи backend
   - Проверить конфигурацию backend (rewrite, алиасы)

2. **Для устранения путаницы в логах:**
   - Использовать разные имена для страницы и API (например, `/search-routes` для страницы)
   - Или добавить префикс для API (уже есть: `/api/v1`)

3. **Для улучшения отладки:**
   - Добавить логирование фактического URL в `fetchApi` перед запросом
   - Добавить логирование параметров в `useRoutesSearch` перед вызовом `fetchApi`

---

## Заключение

**Код работает корректно.** Нет подмены API запроса на навигацию. Если запрос действительно уходит на `/routes` вместо `/api/v1/routes/search`, проблема, вероятно, в:
1. Backend конфигурации (rewrite, алиасы)
2. Отображении в DevTools (относительный путь)
3. Логировании backend (удаление префикса)
4. Сетевом стеке (прокси, firewall)

**Рекомендация:** Проверить фактический запрос в Network tab браузера и логи backend для точного определения проблемы.





