# План обновления зависимостей

**Дата создания:** 2024-12-19  
**Статус:** План подготовлен, обновления отложены до стабильного периода  
**Приоритет:** Низкий (не блокирует продакшен)

## Обзор

Данный документ описывает стратегию безопасного обновления major-версий зависимостей проекта. Все обновления должны выполняться последовательно, с тщательным тестированием на каждом этапе.

**Общий уровень риска:** Средний-Высокий  
**Рекомендуемый момент для обновлений:** После стабильного периода работы в продакшене (минимум 1-2 месяца без критичных инцидентов)

---

## Приоритетный порядок обновлений

### Фаза 1: Низкий риск (изолированные утилиты)
**Время:** 2-4 часа  
**Риск:** Низкий

1. **dotenv** (16.3.1 → 17.2.3)
2. **uuid** (9.0.1 → 13.0.0)

**Обоснование:** Эти пакеты используются изолированно, имеют минимальное влияние на остальной код, breaking changes минимальны.

---

### Фаза 2: Средний риск (инфраструктура)
**Время:** 1-2 дня  
**Риск:** Средний

3. **redis** (4.6.12 → 5.10.0)
4. **bcrypt** (5.1.1 → 6.0.0)

**Обоснование:** Критичные для работы системы, но изменения API относительно предсказуемы. Требуют тщательного тестирования подключений и аутентификации.

---

### Фаза 3: Высокий риск (core framework)
**Время:** 2-3 дня  
**Риск:** Высокий

5. **express** (4.18.2 → 5.1.0)

**Обоснование:** Ядро приложения, используется повсеместно. Express 5 имеет значительные breaking changes в middleware, routing, и обработке запросов. Требует максимального внимания.

---

### Фаза 4: Dev-инфраструктура (тесты и линтеры)
**Время:** 1-2 дня  
**Риск:** Средний

6. **jest** (29.7.0 → 30.x)
7. **eslint** (8.56.0 → 9.39.1)
8. **@typescript-eslint/eslint-plugin** (6.21.0 → 8.47.0)
9. **@typescript-eslint/parser** (6.21.0 → 8.47.0)

**Обоснование:** Обновляются в последнюю очередь, чтобы не усложнять отладку предыдущих шагов. Изменения в конфигурации могут потребовать правок в настройках.

---

## Детальный план по зависимостям

### 1. dotenv (16.3.1 → 17.2.3)

**Текущая версия:** 16.3.1  
**Целевая версия:** 17.2.3  
**Приоритет:** Высокий (Фаза 1)  
**Риск:** Низкий

#### Основные риски
- Изменения в API `dotenv.config()` (минимальные)
- Возможные изменения в обработке путей к `.env` файлам
- Изменения в формате переменных окружения (маловероятно)

#### Затронутые области кода
- `src/index.ts` - загрузка .env файлов
- `src/infrastructure/cache/RedisConnection.ts` - загрузка .env
- `src/infrastructure/database/PostgresConnection.ts` - загрузка .env
- `src/infrastructure/storage/MinIOClient.ts` - загрузка .env
- `src/infrastructure/api/odata-client/odata-client-factory.ts` - загрузка .env

#### Обязательные проверки после обновления
- ✅ Сборка проекта (`npm run build`)
- ✅ TypeScript компиляция (`npm run type-check`)
- ✅ Unit тесты (`npm run test:unit`)
- ✅ Проверка загрузки переменных окружения в разных сценариях:
  - Локальный запуск (`.env` в `backend/`)
  - Docker запуск (`.env` в корне проекта)
  - Переменные из process.env

#### Ручные sanity-проверки
- Запустить приложение локально, проверить, что все переменные окружения загружаются корректно
- Проверить работу в Docker Compose окружении
- Проверить, что отсутствуют ошибки при отсутствии `.env` файла

#### Критерии успешности
- ✅ Проект собирается без ошибок
- ✅ Все тесты проходят
- ✅ Переменные окружения загружаются корректно в обоих сценариях (локально и Docker)
- ✅ Нет предупреждений о deprecated API

---

### 2. uuid (9.0.1 → 13.0.0)

**Текущая версия:** 9.0.1  
**Целевая версия:** 13.0.0  
**Приоритет:** Высокий (Фаза 1)  
**Риск:** Низкий

#### Основные риски
- Изменения в API генерации UUID (возможны изменения в именовании функций)
- Изменения в формате экспорта (ESM vs CommonJS)
- Возможные изменения в типах TypeScript

#### Затронутые области кода
- **Проверка использования:** В текущем коде uuid не используется напрямую (grep не нашел использования)
- Если используется в будущем или в зависимостях - может затронуть:
  - Генерацию ID для сущностей
  - Создание уникальных идентификаторов для запросов/сессий

#### Обязательные проверки после обновления
- ✅ Сборка проекта (`npm run build`)
- ✅ TypeScript компиляция (`npm run type-check`)
- ✅ Unit тесты (`npm run test:unit`)
- ✅ Проверка совместимости с зависимостями, использующими uuid

#### Ручные sanity-проверки
- Проверить, что проект запускается без ошибок
- Если uuid используется в коде - проверить генерацию UUID вручную

#### Критерии успешности
- ✅ Проект собирается без ошибок
- ✅ Все тесты проходят
- ✅ Нет ошибок импорта или использования uuid
- ✅ Типы TypeScript корректны

---

### 3. redis (4.6.12 → 5.10.0)

**Текущая версия:** 4.6.12  
**Целевая версия:** 5.10.0  
**Приоритет:** Средний (Фаза 2)  
**Риск:** Средний-Высокий

#### Основные риски
- **Критично:** Изменения в API клиента Redis
  - Изменения в `createClient()` и конфигурации подключения
  - Изменения в методах работы с данными (get, set, exists, etc.)
  - Возможные изменения в обработке ошибок и переподключениях
- Изменения в типах TypeScript (`RedisClientType`)
- Изменения в формате ответов от Redis команд
- Возможные изменения в работе с транзакциями и pipeline

#### Затронутые области кода
- `src/infrastructure/cache/RedisConnection.ts` - основной клиент Redis
- `src/infrastructure/repositories/PostgresGraphRepository.ts` - использование Redis для графа
- `src/infrastructure/cache/RedisCacheService.ts` - сервис кеширования
- `src/infrastructure/cache/redis-scan.ts` - сканирование ключей
- `src/__tests__/integration/setup.ts` - тестовый Redis клиент
- `src/__tests__/mocks/redis.mock.ts` - моки Redis
- Все integration и E2E тесты, использующие Redis

#### Обязательные проверки после обновления
- ✅ Сборка проекта (`npm run build`)
- ✅ TypeScript компиляция (`npm run type-check`)
- ✅ Unit тесты (`npm run test:unit`)
- ✅ Integration тесты (`npm run test:integration`) - **критично**
- ✅ E2E тесты (`npm run test:e2e`) - **критично**
- ✅ Проверка работы Redis подключения:
  - Подключение с паролем
  - Подключение без пароля
  - Переподключение при разрыве соединения
  - Работа с разными базами данных (DB 0, DB 1 для тестов)

#### Ручные sanity-проверки
- Проверить подключение к Redis в Docker Compose окружении
- Проверить работу health check для Redis (`/health/ready`)
- Проверить работу кеширования:
  - Сохранение данных в Redis
  - Получение данных из Redis
  - TTL для ключей
  - Очистка кеша
- Проверить работу графа в Redis:
  - Сохранение графа
  - Получение графа
  - Работа с метаданными графа
- Проверить работу workers, использующих Redis (GraphBuilderWorker)

#### Критерии успешности
- ✅ Все тесты проходят (особенно integration и E2E)
- ✅ Redis подключение работает стабильно
- ✅ Кеширование работает корректно
- ✅ Граф сохраняется и загружается из Redis
- ✅ Health checks для Redis проходят
- ✅ Нет ошибок переподключения
- ✅ Производительность не деградировала

---

### 4. bcrypt (5.1.1 → 6.0.0)

**Текущая версия:** 5.1.1  
**Целевая версия:** 6.0.0  
**Приоритет:** Средний (Фаза 2)  
**Риск:** Средний

#### Основные риски
- Изменения в API `hash()` и `compare()`
- Возможные изменения в формате хешей (маловероятно, но критично)
- Изменения в обработке ошибок
- Возможные изменения в производительности

#### Затронутые области кода
- **Проверка использования:** В текущем коде bcrypt не используется напрямую (grep не нашел использования)
- Если используется в будущем или в зависимостях - может затронуть:
  - Аутентификацию пользователей
  - Хеширование паролей
  - Валидацию паролей

#### Обязательные проверки после обновления
- ✅ Сборка проекта (`npm run build`)
- ✅ TypeScript компиляция (`npm run type-check`)
- ✅ Unit тесты (`npm run test:unit`)
- ✅ Если bcrypt используется - проверить совместимость хешей:
  - Старые хеши должны валидироваться корректно
  - Новые хеши должны создаваться в правильном формате

#### Ручные sanity-проверки
- Если bcrypt используется:
  - Проверить создание нового хеша пароля
  - Проверить валидацию существующего хеша
  - Проверить, что старые хеши продолжают работать

#### Критерии успешности
- ✅ Проект собирается без ошибок
- ✅ Все тесты проходят
- ✅ Если используется - хеши создаются и валидируются корректно
- ✅ Обратная совместимость со старыми хешами сохранена

---

### 5. express (4.18.2 → 5.1.0)

**Текущая версия:** 4.18.2  
**Целевая версия:** 5.1.0  
**Приоритет:** Высокий (Фаза 3)  
**Риск:** Высокий

#### Основные риски
- **Критично:** Изменения в middleware API
  - Изменения в порядке выполнения middleware
  - Изменения в формате `req` и `res` объектов
  - Изменения в обработке ошибок в middleware
- Изменения в routing:
  - Изменения в работе с параметрами маршрутов
  - Изменения в обработке query параметров
- Изменения в обработке body:
  - `express.json()` и `express.urlencoded()` могут иметь изменения
  - Изменения в лимитах размера body
- Изменения в CORS интеграции
- Изменения в работе с async/await в middleware
- Возможные breaking changes в `Router()`

#### Затронутые области кода
- `src/index.ts` - инициализация Express приложения, middleware stack
- `src/presentation/routes/index.ts` - определение всех маршрутов
- `src/presentation/middleware/` - все middleware:
  - `error-handler.middleware.ts`
  - `rate-limiter.ts` (использует express-rate-limit)
  - `request-logger.middleware.ts`
  - `security-headers.middleware.ts`
  - `validation.middleware.ts`
- `src/presentation/controllers/` - все контроллеры (используют `Request`, `Response`)
- `src/__tests__/integration/api/api-test-helpers.ts` - создание тестового Express app
- `src/__tests__/e2e/e2e.test.ts` - E2E тесты
- Все integration тесты API

#### Обязательные проверки после обновления
- ✅ Сборка проекта (`npm run build`)
- ✅ TypeScript компиляция (`npm run type-check`)
- ✅ Линтер (`npm run lint`)
- ✅ Unit тесты (`npm run test:unit`)
- ✅ Integration тесты (`npm run test:integration`) - **критично**
- ✅ E2E тесты (`npm run test:e2e`) - **критично**
- ✅ Проверка всех middleware:
  - Порядок выполнения
  - Обработка ошибок
  - Работа с `req` и `res`
- ✅ Проверка rate limiting (express-rate-limit совместимость)
- ✅ Проверка CORS
- ✅ Проверка валидации (Zod middleware)

#### Ручные sanity-проверки
- **Health checks:**
  - `GET /health` - общий health check
  - `GET /health/live` - liveness probe
  - `GET /health/ready` - readiness probe
  - `GET /api/v1/health/*` - API варианты
- **Cities API:**
  - `GET /api/v1/cities?page=1&limit=10` - список городов
  - Проверка пагинации
- **Routes API:**
  - `GET /api/v1/routes/search?from=Москва&to=Санкт-Петербург&date=YYYY-MM-DD` - поиск маршрутов
  - `GET /api/v1/routes/build?from=Москва&to=Санкт-Петербург&date=YYYY-MM-DD` - построение маршрута
  - Проверка валидации параметров
  - Проверка rate limiting
- **Risk API:**
  - `POST /api/v1/routes/risk/assess` - оценка риска
  - Проверка валидации body
- **Metrics:**
  - `GET /api/v1/metrics` - Prometheus метрики
- Проверить работу Swagger UI (`/api-docs`)
- Проверить обработку ошибок:
  - 400 (валидация)
  - 404 (не найден)
  - 429 (rate limit)
  - 500 (внутренняя ошибка)

#### Критерии успешности
- ✅ Все тесты проходят (особенно integration и E2E)
- ✅ Все эндпоинты отвечают корректно
- ✅ Middleware работают в правильном порядке
- ✅ Rate limiting работает
- ✅ CORS работает
- ✅ Валидация работает
- ✅ Обработка ошибок работает корректно
- ✅ Swagger UI доступен
- ✅ Метрики собираются
- ✅ Health checks проходят
- ✅ Производительность не деградировала

---

### 6. jest (29.7.0 → 30.x)

**Текущая версия:** 29.7.0  
**Целевая версия:** 30.x  
**Приоритет:** Низкий (Фаза 4)  
**Риск:** Средний

#### Основные риски
- Изменения в конфигурации Jest
- Изменения в API тестирования
- Возможные изменения в работе с моками
- Изменения в формате отчетов
- Возможные изменения в работе с TypeScript (ts-jest)

#### Затронутые области кода
- `jest.config.js` - конфигурация unit тестов
- `jest.integration.config.js` - конфигурация integration тестов
- `jest.e2e.config.js` - конфигурация E2E тестов
- `src/__tests__/setup.ts` - глобальный setup для unit тестов
- `src/__tests__/integration/setup.ts` - setup для integration тестов
- Все тестовые файлы (могут потребовать обновления синтаксиса)

#### Обязательные проверки после обновления
- ✅ Сборка проекта (`npm run build`)
- ✅ Unit тесты (`npm run test:unit`) - **критично**
- ✅ Integration тесты (`npm run test:integration`) - **критично**
- ✅ E2E тесты (`npm run test:e2e`) - **критично**
- ✅ Проверка coverage (`npm run test:coverage`)
- ✅ Проверка работы моков
- ✅ Проверка работы с async/await в тестах

#### Ручные sanity-проверки
- Запустить все тестовые наборы по отдельности
- Проверить, что coverage генерируется корректно
- Проверить, что тесты запускаются в watch режиме (`npm run test:watch`)

#### Критерии успешности
- ✅ Все тесты проходят (121 unit, 27 integration, 4 E2E)
- ✅ Coverage генерируется корректно
- ✅ Моки работают
- ✅ Конфигурации Jest валидны
- ✅ Нет предупреждений о deprecated API

---

### 7. eslint (8.56.0 → 9.39.1)

**Текущая версия:** 8.56.0  
**Целевая версия:** 9.39.1  
**Приоритет:** Низкий (Фаза 4)  
**Риск:** Средний

#### Основные риски
- **Критично:** Изменения в формате конфигурации (flat config)
  - ESLint 9 использует новый формат конфигурации
  - Старый формат `.eslintrc.*` не поддерживается
- Изменения в работе правил
- Изменения в API плагинов
- Возможные изменения в интеграции с TypeScript

#### Затронутые области кода
- Конфигурация ESLint (`.eslintrc.*` или `eslint.config.js`)
- `package.json` - скрипт `lint`
- Все файлы с кодом (могут потребовать правок по новым правилам)

#### Обязательные проверки после обновления
- ✅ Сборка проекта (`npm run build`)
- ✅ TypeScript компиляция (`npm run type-check`)
- ✅ Линтер (`npm run lint`) - **критично**
- ✅ Unit тесты (`npm run test:unit`)
- ✅ Проверка, что все файлы проходят линтинг

#### Ручные sanity-проверки
- Запустить линтер на всех файлах
- Проверить, что нет новых ошибок линтинга
- Проверить работу в IDE (если используется ESLint extension)

#### Критерии успешности
- ✅ Линтер проходит без ошибок
- ✅ Конфигурация ESLint обновлена на новый формат (flat config)
- ✅ Все правила работают корректно
- ✅ Нет ложных срабатываний

---

### 8. @typescript-eslint/eslint-plugin (6.21.0 → 8.47.0)

**Текущая версия:** 6.21.0  
**Целевая версия:** 8.47.0  
**Приоритет:** Низкий (Фаза 4)  
**Риск:** Средний

#### Основные риски
- Изменения в правилах TypeScript ESLint
- Изменения в конфигурации правил
- Возможные новые правила, которые могут выявить проблемы в коде
- Изменения в интеграции с ESLint 9

#### Затронутые области кода
- Конфигурация ESLint (правила TypeScript)
- Все TypeScript файлы (могут потребовать правок по новым правилам)

#### Обязательные проверки после обновления
- ✅ Линтер (`npm run lint`) - **критично**
- ✅ TypeScript компиляция (`npm run type-check`)
- ✅ Unit тесты (`npm run test:unit`)

#### Ручные sanity-проверки
- Запустить линтер, проверить новые предупреждения
- Исправить или отключить новые правила, если они слишком строгие

#### Критерии успешности
- ✅ Линтер проходит без ошибок
- ✅ Новые правила настроены корректно
- ✅ Нет ложных срабатываний

---

### 9. @typescript-eslint/parser (6.21.0 → 8.47.0)

**Текущая версия:** 6.21.0  
**Целевая версия:** 8.47.0  
**Приоритет:** Низкий (Фаза 4)  
**Риск:** Средний

#### Основные риски
- Изменения в парсинге TypeScript кода
- Возможные изменения в поддержке новых версий TypeScript
- Изменения в интеграции с ESLint 9

#### Затронутые области кода
- Конфигурация ESLint (parser settings)
- Все TypeScript файлы

#### Обязательные проверки после обновления
- ✅ Линтер (`npm run lint`) - **критично**
- ✅ TypeScript компиляция (`npm run type-check`)
- ✅ Unit тесты (`npm run test:unit`)

#### Ручные sanity-проверки
- Запустить линтер, проверить, что парсинг работает корректно
- Проверить работу в IDE

#### Критерии успешности
- ✅ Линтер проходит без ошибок
- ✅ Парсер корректно обрабатывает TypeScript код
- ✅ Нет ошибок парсинга

---

## Общий регламент обновления зависимостей

### Принципы

1. **Обновлять по одному пакету или небольшой логической группе**
   - Для Фазы 1 (dotenv, uuid) - можно обновлять вместе
   - Для Фазы 2 (redis, bcrypt) - обновлять по отдельности
   - Для Фазы 3 (express) - только по одному
   - Для Фазы 4 (jest, eslint, @typescript-eslint) - можно обновлять вместе (jest отдельно, eslint + @typescript-eslint вместе)

2. **На каждую группу - отдельная ветка и отдельный PR**
   - Ветка: `chore/update-dependency-{package-name}-{version}`
   - PR должен содержать:
     - Описание изменений
     - Список breaking changes (если есть)
     - Результаты тестирования
     - Ссылку на документацию обновления

3. **Обязательные шаги для каждого обновления:**
   - ✅ Изучить changelog и migration guide пакета
   - ✅ Обновить версию в `package.json`
   - ✅ Установить зависимости (`npm install`)
   - ✅ Собрать проект (`npm run build`)
   - ✅ Проверить линтер (`npm run lint`)
   - ✅ Проверить TypeScript (`npm run type-check`)
   - ✅ Запустить unit тесты (`npm run test:unit`)
   - ✅ Запустить integration тесты (`npm run test:integration`) - если доступна БД
   - ✅ Запустить E2E тесты (`npm run test:e2e`) - если доступна БД
   - ✅ Выполнить ручные sanity-проверки (см. раздел для каждой зависимости)
   - ✅ Зафиксировать результат в `PRODUCTION_EXECUTION_LOG.md`

4. **Если что-то ломается:**
   - Чётко обозначить проблему в PR
   - Попытаться исправить (если это быстро)
   - Если исправление требует значительных изменений - откатить версию и перенести обновление в более поздний этап
   - Зафиксировать в `REMAINING_TASKS.md` с описанием проблемы

5. **После успешного обновления:**
   - Обновить `PRODUCTION_EXECUTION_LOG.md` с записью о выполнении
   - Обновить `REMAINING_TASKS.md` (отметить как выполненное)
   - Обновить `DEPENDENCY_UPDATE_PLAN.md` (отметить зависимость как обновлённую)

### Процесс обновления (пошагово)

1. **Подготовка:**
   ```bash
   git checkout -b chore/update-dependency-{package-name}-{version}
   ```

2. **Изучение изменений:**
   - Прочитать changelog пакета
   - Прочитать migration guide (если есть)
   - Определить breaking changes

3. **Обновление:**
   ```bash
   npm install {package-name}@^{target-version}
   ```

4. **Проверка компиляции:**
   ```bash
   npm run build
   npm run type-check
   ```

5. **Исправление кода (если необходимо):**
   - Исправить breaking changes
   - Обновить типы
   - Обновить использование API

6. **Тестирование:**
   ```bash
   npm run lint
   npm run test:unit
   npm run test:integration  # если доступна БД
   npm run test:e2e  # если доступна БД
   ```

7. **Ручные проверки:**
   - Выполнить sanity-проверки из раздела для зависимости
   - Проверить работу в Docker Compose окружении

8. **Фиксация результатов:**
   - Обновить `PRODUCTION_EXECUTION_LOG.md`
   - Создать PR с описанием изменений

9. **Code review и merge:**
   - После approval - merge в основную ветку
   - Обновить `REMAINING_TASKS.md`

---

## Резюме

### Общий уровень риска обновления зависимостей

**Оценка:** Средний-Высокий

- **Низкий риск:** dotenv, uuid (изолированные утилиты)
- **Средний риск:** redis, bcrypt, jest, eslint, @typescript-eslint (инфраструктура)
- **Высокий риск:** express (core framework, используется повсеместно)

### Рекомендуемый момент для обновлений

**Оптимальное время:** После стабильного периода работы в продакшене

- Минимум 1-2 месяца без критичных инцидентов
- После завершения активной разработки новых фич
- Перед следующим крупным релизом (если планируется)
- В период низкой нагрузки на систему

**Не рекомендуется обновлять:**
- Во время активной разработки новых фич
- Перед важными деплоями
- Во время критичных инцидентов

### "Быстрые победы" (обновления с высокой вероятностью успеха)

1. **dotenv (16.3.1 → 17.2.3)**
   - Минимальные breaking changes
   - Изолированное использование
   - Быстрое обновление (1-2 часа)

2. **uuid (9.0.1 → 13.0.0)**
   - Не используется напрямую в коде (пока)
   - Минимальное влияние
   - Быстрое обновление (1 час)

3. **jest (29.7.0 → 30.x)**
   - Относительно стабильные изменения
   - Хорошая обратная совместимость
   - Обновление за 2-4 часа

### "Опасные кандидаты" (требуют максимального внимания)

1. **express (4.18.2 → 5.1.0)** ⚠️ **КРИТИЧНО**
   - Множественные breaking changes
   - Используется повсеместно
   - Требует тщательного тестирования всех эндпоинтов
   - Время обновления: 2-3 дня
   - **Рекомендация:** Обновлять в последнюю очередь, после всех остальных

2. **redis (4.6.12 → 5.10.0)** ⚠️ **ВЫСОКИЙ РИСК**
   - Критичная зависимость для работы системы
   - Изменения в API клиента
   - Требует тестирования всех операций с Redis
   - Время обновления: 1-2 дня
   - **Рекомендация:** Обновлять после dotenv/uuid, но до express

3. **eslint + @typescript-eslint (8.56.0 → 9.39.1, 6.21.0 → 8.47.0)** ⚠️ **СРЕДНИЙ РИСК**
   - Изменения в формате конфигурации (flat config)
   - Может потребовать правок в настройках
   - Время обновления: 1 день
   - **Рекомендация:** Обновлять вместе, в последнюю очередь (после express)

### План действий (кратко)

1. **Фаза 1 (Низкий риск):** dotenv, uuid → 2-4 часа
2. **Фаза 2 (Средний риск):** redis, bcrypt → 1-2 дня
3. **Фаза 3 (Высокий риск):** express → 2-3 дня
4. **Фаза 4 (Dev-инфраструктура):** jest, eslint, @typescript-eslint → 1-2 дня

**Общее время:** 5-10 дней (с учетом тестирования и возможных проблем)

---

## Примечания

- Все обновления должны выполняться в отдельной ветке
- Каждое обновление должно быть зафиксировано в `PRODUCTION_EXECUTION_LOG.md`
- При возникновении проблем - откатить изменения и зафиксировать в `REMAINING_TASKS.md`
- Рекомендуется обновлять зависимости в период низкой нагрузки на систему
- Перед обновлением express - убедиться, что все остальные зависимости обновлены и стабильны

---

**Последнее обновление:** 2024-12-19  
**Следующий пересмотр плана:** После первого успешного обновления или при изменении приоритетов