# Анализ текущих данных и план улучшения реалистичности

**Дата создания:** 2024-12-20  
**Цель:** Привести демо-данные к состоянию "правдоподобный реальный сервис" для Якутии

---

## Этап 1: Анализ текущих данных и UI

### Где лежат моки

**Файлы мок-данных:**
- `backend/data/mock/stops.json` - остановки (26 записей)
- `backend/data/mock/routes.json` - маршруты (126 записей после расширения)
- `backend/data/mock/flights.json` - рейсы (242 записи после расширения)
- `backend/data/mock/yakutia-cities-reference.json` - справочник городов Якутии (15 городов)

**Как данные попадают в систему:**
1. `ODataSyncWorker` загружает моки из JSON-файлов в PostgreSQL
2. `VirtualEntitiesGeneratorWorker` создает виртуальные остановки/маршруты для городов без реальных данных
3. `GraphBuilderWorker` строит граф из данных PostgreSQL и сохраняет в Redis
4. `OptimizedBuildRouteUseCase` использует граф из Redis для поиска маршрутов

### Текущие поля данных

#### Остановки (stops.json)
**Реальные поля:**
- `id` - уникальный идентификатор
- `name` - название остановки (например, "Аэропорт Якутск (Туймаада)")
- `coordinates.latitude/longitude` - координаты (реальные для Якутии)
- `type` - тип остановки (airport, bus_station, train_station, bus_stop)

**Выдуманные/отсутствующие поля:**
- ❌ Адрес остановки
- ❌ Контактная информация
- ❌ Расписание работы
- ❌ Услуги (камера хранения, кафе и т.д.)

#### Маршруты (routes.json)
**Реальные поля:**
- `id` - уникальный идентификатор
- `name` - название маршрута (например, "Якутск - Олёкминск (Автобус)")
- `routeNumber` - номер маршрута (частично выдуманный)
- `transportType` - тип транспорта (PLANE, BUS, TRAIN)
- `stops` - массив ID остановок
- `baseFare` - базовая цена (теперь реалистичная, рассчитанная на основе расстояний)

**Выдуманные/отсутствующие поля:**
- ❌ Реальные расписания (только в flights.json)
- ❌ Длительность маршрута (вычисляется из графа)
- ❌ Расстояние (вычисляется из координат)
- ❌ Оператор перевозки
- ❌ Классы обслуживания
- ❌ Условия отмены/возврата

#### Рейсы (flights.json)
**Реальные поля:**
- `id` - уникальный идентификатор
- `routeId` - ID маршрута
- `departureTime/arrivalTime` - время отправления/прибытия (теперь реалистичное, рассчитанное на основе расстояний)
- `fromStopId/toStopId` - ID остановок
- `price` - цена (теперь реалистичная, рассчитанная на основе расстояний)
- `availableSeats` - доступные места (выдуманное)

**Выдуманные/отсутствующие поля:**
- ❌ Реальные расписания авиакомпаний
- ❌ Реальные цены билетов
- ❌ Номера рейсов (частично выдуманные)
- ❌ Статус рейса (задержки, отмены)
- ❌ Классы обслуживания
- ❌ Багаж (включен/дополнительно)

### Что нужно для UX

**Критичные поля:**
1. ✅ Тип транспорта - есть (`transportType`)
2. ✅ Расписание - есть (в flights.json, теперь реалистичное)
3. ✅ Тарифы - есть (`price`, теперь реалистичные)
4. ⚠️ Альтернативы - частично (через граф, но не всегда оптимальные)
5. ⚠️ Оценка риска - есть (базовая логика), но можно улучшить

**Желательные поля:**
- Оператор перевозки
- Классы обслуживания
- Условия отмены/возврата
- Информация о багаже
- Услуги на остановках

### Данные, которые есть в бэкенде, но не доходят до фронта

**Проверено:**
- ✅ `totalDuration` - длительность маршрута (есть в ответе API)
- ✅ `totalPrice` - общая цена (есть в ответе API)
- ✅ `segments` - сегменты маршрута (есть в ответе API)
- ✅ `transferCount` - количество пересадок (есть в ответе API)
- ✅ `transportTypes` - типы транспорта (есть в ответе API)
- ✅ `departureTime/arrivalTime` - время отправления/прибытия (есть в ответе API)

**Проблема:** Адаптер `route-adapter.ts` преобразует данные, но некоторые поля могут теряться из-за несоответствия структур.

---

## Этап 2: Поиск реальных источников данных

### Найденные источники

**1. Авиакомпании Якутии:**
- **Polar Airlines** (Полярные авиалинии) - региональные рейсы
- **Якутия** (авиакомпания) - основные направления
- **S7 Airlines** - рейсы в крупные города

**Ограничения:**
- Нет публичного API
- Расписания меняются сезонно
- Цены динамические

**Рекомендация:** Использовать реальные расписания из открытых источников (сайты авиакомпаний) как базовые моки, обновлять вручную.

**2. Автобусные перевозки:**
- **Якутское ПАТП** - автобусные маршруты
- **Частные перевозчики** - междугородние рейсы

**Ограничения:**
- Нет единого API
- Расписания на сайтах автовокзалов
- Цены могут варьироваться

**Рекомендация:** Использовать типичные расписания и цены для автобусных маршрутов Якутии.

**3. Речной транспорт:**
- **Ленское пароходство** - речные перевозки по Лене
- Сезонные маршруты (лето)

**Ограничения:**
- Сезонность (только лето)
- Ограниченные направления

**Рекомендация:** Добавить как опциональный тип транспорта для летних месяцев.

### Реальные направления и расстояния

**Ключевые направления Якутии:**
1. **Якутск → Нерюнгри** (~800 км)
   - Автобус: ~12-14 часов, ~2000-2500 руб
   - Самолет: ~1.5 часа, ~8000-12000 руб

2. **Якутск → Мирный** (~1200 км)
   - Автобус: ~18-20 часов, ~3000-4000 руб
   - Самолет: ~2 часа, ~10000-15000 руб

3. **Якутск → Ленск** (~840 км)
   - Автобус: ~12-14 часов, ~2500-3000 руб
   - Самолет: ~1.5 часа, ~7000-10000 руб

4. **Якутск → Олёкминск** (~530 км)
   - Автобус: ~8-10 часов, ~1500-2000 руб
   - Самолет: ~1 час, ~6000-8000 руб

5. **Якутск → Тикси** (~1200 км)
   - Самолет: ~2.5 часа, ~15000-20000 руб
   - Автобус: нет (только зимник, сезонно)

### Правила расчета оценочных данных

**Для автобусов:**
- Скорость: ~60-70 км/ч (с учетом остановок)
- Цена: ~3-4 руб/км
- Время в пути: расстояние / 65 км/ч + 10% (остановки)

**Для самолетов:**
- Скорость: ~500-600 км/ч
- Цена: ~10-15 руб/км (региональные рейсы)
- Время в пути: расстояние / 550 км/ч + 30 мин (взлет/посадка)

**Для речного транспорта (лето):**
- Скорость: ~20-25 км/ч
- Цена: ~2-3 руб/км
- Время в пути: расстояние / 22 км/ч

---

## Этап 3: Новый слой "реалистичных данных"

### Проектируемая структура

**Интерфейс сущностей:**
```typescript
interface RealisticRouteData {
  // Базовые данные
  routeId: string;
  fromCity: string;
  toCity: string;
  transportType: 'PLANE' | 'BUS' | 'TRAIN' | 'FERRY';
  
  // Реальные/оценочные данные
  distance: number; // км (из координат)
  estimatedDuration: number; // минуты (реальное или оценочное)
  priceRange: { min: number; max: number }; // диапазон цен
  basePrice: number; // средняя цена
  
  // Расписание
  schedule: {
    frequency: 'daily' | 'weekly' | 'seasonal';
    typicalDepartureTimes: string[]; // HH:MM
    seasonal?: { start: string; end: string }; // для сезонных маршрутов
  };
  
  // Метаданные
  operator?: string; // оператор перевозки
  dataSource: 'real' | 'estimated' | 'virtual'; // источник данных
  lastUpdated?: string; // дата последнего обновления
}
```

### План обновления мок-данных

**Приоритет 1: Ключевые направления (реальные данные)**
- Якутск → Нерюнгри
- Якутск → Мирный
- Якутск → Ленск
- Якутск → Олёкминск
- Якутск → Тикси

**Приоритет 2: Остальные направления (оценочные данные)**
- Все остальные пары городов из `yakutia-cities-reference.json`
- Использовать правила расчета на основе расстояний

**Приоритет 3: Виртуальные маршруты**
- Только для обеспечения связности
- Помечать как `dataSource: 'virtual'`

---

## Этап 4: Расширение API и UI

### Бэкенд

**Текущий контракт:**
```typescript
{
  success: boolean;
  routes: RouteResult[];
  alternatives?: RouteResult[];
  executionTimeMs: number;
  graphVersion?: string;
  graphAvailable: boolean;
}
```

**Расширения (не ломающие текущий контракт):**
- Добавить `dataSource: 'real' | 'estimated' | 'virtual'` к каждому маршруту
- Добавить `operator?: string` к каждому сегменту
- Добавить `schedule?: ScheduleInfo` к каждому маршруту
- Добавить `priceRange?: { min: number; max: number }` к каждому маршруту

### Фронтенд

**Страница /routes:**
- ✅ Отображение маршрутов - работает
- ✅ Отображение типа транспорта - работает
- ❌ Отображение оператора - нужно добавить
- ❌ Отображение источника данных (реальный/оценочный) - нужно добавить
- ✅ Отображение расписания - работает

**Страница /routes/details:**
- ❌ Блок "Тип транспорта" - нужно наполнить
- ❌ Блок "Расписание рейсов" - нужно наполнить
- ❌ Блок "Стоимость и тарифы" - нужно наполнить
- ❌ Блок "Альтернативные варианты" - нужно наполнить
- ⚠️ Блок "Оценка рисков" - базовая логика есть, нужно улучшить

---

## Этап 5: Альтернативные маршруты

**Текущее состояние:**
- Граф находит кратчайший путь
- Альтернативы не генерируются явно

**План:**
- Найти несколько путей в графе (не только кратчайший)
- Сортировать по критериям: время, цена, количество пересадок
- Отдавать до 3-5 альтернатив

---

## Этап 6: Проверки и тесты

**Текущие тесты:**
- ✅ Unit-тесты для use cases
- ✅ Integration-тесты для поиска маршрутов
- ✅ E2E-тесты для основных сценариев

**Нужно добавить:**
- Тесты для адаптера данных
- Тесты для отображения реалистичных данных
- Тесты для альтернативных маршрутов

---

## Выполненные изменения

### Расширение мок-данных (2024-12-20)

**Создан скрипт генерации маршрутов:**
- `backend/scripts/generate-realistic-routes.js` - генерирует маршруты для всех пар городов Якутии
- Использует `yakutia-cities-reference.json` как источник правды
- Рассчитывает расстояния по формуле Haversine
- Определяет оптимальный тип транспорта на основе расстояния
- Рассчитывает реалистичные цены и времена в пути

**Результаты:**
- Добавлено 105 новых маршрутов между городами Якутии
- Добавлено 210 новых рейсов с реалистичными расписаниями
- Всего: **126 маршрутов** и **242 рейса**
- Все маршруты имеют реалистичные цены (3-4 руб/км для автобусов, 10-15 руб/км для самолетов)
- Все маршруты имеют реалистичные времена в пути (на основе расстояний и типов транспорта)

**Покрытие:**
- ✅ Все 15 городов из справочника имеют остановки
- ✅ Все пары городов Якутии имеют хотя бы один маршрут
- ✅ Для длинных расстояний (>500 км) используется самолет
- ✅ Для коротких расстояний (<500 км) используется автобус

**Создана утилита для расчета оценок:**
- `backend/src/shared/utils/route-estimator.ts` - утилиты для расчета реалистичных оценок маршрутов
- Функции: `calculateHaversineDistance`, `estimateRouteDuration`, `estimateRoutePrice`, `getOptimalTransportType`
- Может использоваться в VirtualEntitiesGeneratorWorker и других местах

### Обновление CitiesController (2024-12-20)

**Изменения:**
- `CitiesController.getCities()` теперь использует `yakutia-cities-reference.json` как fallback
- Гарантирует, что все города из справочника доступны в API `/api/v1/cities`
- Если город есть в справочнике, но нет остановок, он все равно будет в списке доступных городов

**Преимущества:**
- Фронтенд всегда видит все города из справочника
- Пользователь может выбрать любой город из справочника, даже если для него еще нет остановок
- VirtualEntitiesGeneratorWorker создаст остановки для таких городов

---

## Следующие шаги

1. ✅ Создать документ анализа (этот файл)
2. ✅ Расширить мок-данные реальными/оценочными значениями
3. ✅ Обновить CitiesController для использования справочника городов
4. ⏳ Обновить VirtualEntitiesGeneratorWorker для использования route-estimator
5. ⏳ Расширить API контракт (без breaking changes)
6. ⏳ Обновить фронтенд для отображения новых полей
7. ⏳ Добавить генерацию альтернативных маршрутов
8. ⏳ Обновить тесты

---

**Последнее обновление:** 2024-12-20
