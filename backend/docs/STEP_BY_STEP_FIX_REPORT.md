# Пошаговый отчёт: Исправление проблемы с городами

**Дата:** 2025-01-27  
**Метод:** Пошаговая диагностика и исправление

---

## ШАГ 1 — Проверка unified reference ✅

### Результаты:

**Файлы справочников:**
- `backend/data/mock/yakutia-cities-reference.json` — 16 городов
- `backend/data/reference/russia-federal-cities-reference.json` — 14 городов
- **Итого:** 30 городов

**Отсутствующие города:**
- ❌ Чурапча
- ❌ Амга
- ❌ Томмот

---

## ШАГ 2 — Проверка CitiesController.ts ✅

### Найденные участки:

**Нормализация:**
- Строки 150, 176, 188 — нормализация для реальных остановок
- Строки 204, 230, 242 — нормализация для виртуальных остановок
- Строка 280 — нормализация в финальном шаге

**Фильтрация:**
- Строки 153-158 — фильтрация по unified reference для реальных остановок
- Строки 177-183 — дополнительная фильтрация
- Строки 189, 243 — проверка дубликатов

**Финальная вставка:**
- Строки 254-326 — финальный шаг добавления всех городов из unified reference
- Строка 283 — **критическая строка:** `citiesSet.add(city.name)` — добавляет все города

**Потенциальные проблемы:**
- ✅ Финальный шаг работает правильно
- ⚠️ Пагинация обрезает массив до `limit` элементов (строка 335)

---

## ШАГ 3 — Проверка pagination ✅

### Результаты:

**Файл:** `backend/src/shared/utils/pagination.ts`

**Проблема найдена:**
- Строка 45: `defaultLimit: number = 20`
- Строка 331 в CitiesController: `parsePaginationParams(req.query)` — использует defaultLimit=20

**Причина проблемы:**
- При запросе `/api/v1/cities` без параметра `limit` возвращаются только первые 20 городов
- Остальные 10 городов находятся на второй странице
- Фронтенд видит только 20 городов в массиве `data`

---

## ШАГ 4 — Предложение исправлений ✅

### Список изменений:

1. **Исправить пагинацию:**
   - Изменить `parsePaginationParams(req.query)` на `parsePaginationParams(req.query, 100)` в CitiesController.ts

2. **Добавить отсутствующие города:**
   - Добавить Чурапча, Амга, Томмот в `yakutia-cities-reference.json`

3. **Перезапустить pipeline:**
   - После добавления городов перезапустить pipeline для создания virtual stops

---

## ШАГ 5 — Применение исправлений ✅

### Изменённые файлы:

#### 1. `backend/src/presentation/controllers/CitiesController.ts`

**Строка 331-332:**
```typescript
// БЫЛО:
const { page, limit } = parsePaginationParams(req.query);

// СТАЛО:
// CRITICAL FIX: Use defaultLimit=100 for cities endpoint to return all cities by default
const { page, limit } = parsePaginationParams(req.query, 100);
```

**Результат:**
- Теперь `defaultLimit = 100` для `/api/v1/cities`
- Все города возвращаются по умолчанию

#### 2. `backend/data/mock/yakutia-cities-reference.json`

**Добавлены 3 города (после строки 132):**

1. **Чурапча:**
   - `name`: "Чурапча"
   - `normalizedName`: "чурапча"
   - `latitude`: 61.9983
   - `longitude`: 132.4333
   - `isKeyCity`: false
   - `description`: "Районный центр на реке Амга"

2. **Амга:**
   - `name`: "Амга"
   - `normalizedName`: "амга"
   - `latitude`: 60.9000
   - `longitude`: 131.9667
   - `isKeyCity`: false
   - `description`: "Районный центр на реке Амга"

3. **Томмот:**
   - `name`: "Томмот"
   - `normalizedName`: "томмот"
   - `latitude`: 58.9564
   - `longitude`: 126.2925
   - `isKeyCity`: false
   - `description`: "Город на реке Алдан"

**Результат:**
- Теперь в unified reference **33 города** (19 якутских + 14 федеральных)

---

## ШАГ 6 — Проверка результатов

### Что нужно проверить:

1. **Перезапустить backend:**
   ```bash
   docker-compose restart backend
   ```

2. **Проверить API:**
   ```bash
   curl http://localhost:5000/api/v1/cities
   ```
   
   **Ожидаемый результат:**
   - `data.length` = 33 (или 30, если новые города ещё не обработаны pipeline)
   - `pagination.total` = 33 (или 30)
   - Все города из unified reference присутствуют

3. **Проверить с limit=100:**
   ```bash
   curl http://localhost:5000/api/v1/cities?limit=100
   ```
   
   **Ожидаемый результат:**
   - `data.length` = 33
   - Все города присутствуют

4. **Проверить новые города:**
   - Чурапча должна быть в ответе
   - Амга должна быть в ответе
   - Томмот должна быть в ответе

5. **Перезапустить pipeline:**
   - После перезапуска backend нужно запустить pipeline для создания virtual stops для новых городов
   - Проверить логи VirtualEntitiesGeneratorWorker на создание virtual stops для Чурапча, Амга, Томмот

---

## Итоговый статус

### ✅ Исправления применены:

1. ✅ Пагинация исправлена — `defaultLimit = 100` для `/api/v1/cities`
2. ✅ Добавлены 3 города в unified reference — Чурапча, Амга, Томмот
3. ✅ Проверка линтера — ошибок нет

### ⏳ Требуется выполнить:

1. ⏳ Перезапустить backend (выполнено через docker-compose)
2. ⏳ Проверить API `/api/v1/cities` — должно вернуть все 33 города
3. ⏳ Перезапустить pipeline для создания virtual stops для новых городов
4. ⏳ Проверить, что все города появляются в ответе API

---

## Следующие шаги

1. **Проверить API:**
   - Запросить `/api/v1/cities` и убедиться, что возвращаются все 33 города
   - Проверить, что новые города (Чурапча, Амга, Томмот) присутствуют

2. **Перезапустить pipeline:**
   - Запустить DataInitialization для создания virtual stops для новых городов
   - Проверить логи VirtualEntitiesGeneratorWorker

3. **Проверить фронтенд:**
   - Убедиться, что все города отображаются в автокомплите
   - Проверить поиск маршрутов для новых городов

---

## Критерии успеха

✅ Запрос `/api/v1/cities` возвращает все 33 города (без параметра limit)  
✅ `pagination.total` = 33  
✅ `data.length` = 33  
✅ Все города имеют оригинальные названия (не нормализованные)  
✅ Города Чурапча, Амга, Томмот присутствуют в ответе  
✅ Фронтенд отображает все города в автокомплите  
✅ Поиск маршрутов работает для всех направлений  

