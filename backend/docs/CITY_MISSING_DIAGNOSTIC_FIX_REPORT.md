# Отчёт о диагностике и исправлении проблемы пропажи городов

## Дата: 2025-01-27

## Проблема

После выполнения pipeline некоторые города пропали из `/api/v1/cities` и не отображаются во фронтенде (например, Якутск, Олёкминск, Чурапча и другие).

## Анализ проблемы

### Найденные проблемы

1. **CitiesController.ts - Fallback на нормализованные названия**
   - **Проблема**: Если `getUnifiedCity(normalizedCityId)` не находил город в unified reference, использовался fallback на `normalizedCityId` (например, "якутск" вместо "Якутск")
   - **Причина**: Логика добавляла нормализованные названия в список городов, которые затем не перезаписывались оригинальными названиями из unified reference
   - **Влияние**: Города отображались с нормализованными названиями или вообще пропадали, если не были найдены в unified reference

2. **CitiesController.ts - Логика добавления городов из unified reference**
   - **Проблема**: Города из unified reference добавлялись только если их не было в `normalizedCitiesMap`, но если город уже был добавлен с нормализованным названием, он не перезаписывался
   - **Причина**: Проверка `!normalizedCitiesMap.has(normalized)` пропускала города, которые уже были добавлены с нормализованными названиями
   - **Влияние**: Некоторые города оставались с нормализованными названиями вместо оригинальных

3. **VirtualEntitiesGeneratorWorker.ts - Поиск города в citiesMap**
   - **Проблема**: Поиск города в `citiesMap` выполнялся только по оригинальному названию, но `cityName` из `missingCities` мог быть уже нормализован
   - **Причина**: `citiesMap` использовал `city.name` как ключ, но `cityName` мог не совпадать с оригинальным названием
   - **Влияние**: Виртуальные остановки могли создаваться с неправильными данными или вообще не создаваться

## Исправления

### 1. CitiesController.ts

**Изменение 1: Убрать fallback на нормализованные названия**
- Удалён fallback на `normalizedCityId` для реальных остановок (строки 157-158)
- Удалён fallback на `normalizedCityId` для виртуальных остановок (строки 210-211)
- Если город не найден в unified reference, он не добавляется в список (будет добавлен из unified reference в конце)

**Изменение 2: Гарантировать перезапись нормализованных названий**
- Изменена логика добавления городов из unified reference (строки 248-260)
- Теперь города из unified reference всегда перезаписывают любые нормализованные версии оригинальными названиями
- Используется `normalizedCitiesMap.set(normalized, city.name)` вместо проверки `!normalizedCitiesMap.has(normalized)`

### 2. VirtualEntitiesGeneratorWorker.ts

**Изменение: Улучшить поиск города в citiesMap**
- Созданы две карты: `citiesMapByName` (по оригинальному названию) и `citiesMapByNormalized` (по нормализованному названию)
- Поиск выполняется сначала по оригинальному названию, затем по нормализованному
- Используется оригинальное название города из unified reference для `name` виртуальной остановки
- `cityId` устанавливается как нормализованное название из unified reference

## Ожидаемый результат

После исправлений:

1. **Все города из unified reference отображаются с оригинальными названиями**
   - Якутск, Олёкминск, Чурапча, Мирный, Верхоянск и другие города должны отображаться корректно
   - Нормализованные названия не попадают в список городов

2. **Виртуальные остановки создаются с правильными данными**
   - `cityId` устанавливается как нормализованное название из unified reference
   - `name` устанавливается как оригинальное название из unified reference

3. **CitiesController корректно обрабатывает все остановки**
   - Реальные остановки: `cityId` нормализуется и используется для поиска в unified reference
   - Виртуальные остановки: `cityId` нормализуется и используется для поиска в unified reference
   - Все города из unified reference добавляются в список с оригинальными названиями

## Проверка после исправлений

### Контрольные города для проверки:
- Якутск
- Олёкминск
- Чурапча
- Мирный
- Верхоянск
- Алдан
- Амга
- Чокурдах

### Контрольные маршруты для проверки:
- Якутск → Москва
- Москва → Чурапча
- Якутск → Олёкминск
- Олёкминск → Ленск
- Мирный → Владивосток
- Верхоянск → Мирный

### Шаги проверки:

1. **Перезапустить pipeline**:
   ```bash
   docker-compose restart backend
   ```

2. **Проверить `/api/v1/cities`**:
   - Все контрольные города должны присутствовать
   - Все города должны иметь оригинальные названия (не нормализованные)

3. **Проверить фронтенд**:
   - Все города должны отображаться в автокомплите
   - Поиск маршрутов должен работать для всех контрольных направлений

4. **Проверить логи backend**:
   - `CitiesController` должен логировать корректное количество городов
   - Не должно быть предупреждений о городах, не найденных в unified reference

## Изменённые файлы

1. `backend/src/presentation/controllers/CitiesController.ts`
   - Убран fallback на нормализованные названия
   - Изменена логика добавления городов из unified reference

2. `backend/src/application/workers/VirtualEntitiesGeneratorWorker.ts`
   - Улучшен поиск города в `citiesMap`
   - Используется оригинальное название города из unified reference

## Статус

✅ **Исправления применены**

Все найденные проблемы исправлены. Система должна корректно отображать все города из unified reference с оригинальными названиями.


