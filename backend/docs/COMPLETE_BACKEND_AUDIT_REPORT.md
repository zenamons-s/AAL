# Полный аудит бэкенда: Проблема с пропажей городов в /api/v1/cities

**Дата:** 2025-01-27  
**Проблема:** Фронтенд получает только 20 городов вместо 30 из unified reference

---

## Найденные ошибки

### ❌ ОШИБКА #1: Пагинация по умолчанию limit=20

**Файл:** `backend/src/shared/utils/pagination.ts`  
**Строки:** 43-52

**Причина проблемы:**
- По умолчанию `defaultLimit = 20` (строка 45)
- Если фронтенд запрашивает `/api/v1/cities` без параметра `limit`, он получает только первые 20 городов
- Остальные 10 городов находятся на второй странице (`page=2`)
- `pagination.total` должен быть 30, но `data` содержит только 20 элементов

**Как воспроизвести:**
1. Запросить `/api/v1/cities` без параметров
2. Получить ответ с `data.length = 20` и `pagination.total = 30`
3. Фронтенд видит только 20 городов в массиве `data`

**Почему фронтенд видит только 20 городов:**
- Фронтенд, вероятно, не делает запросы на все страницы
- Фронтенд не использует параметр `limit=100` для получения всех городов
- Фронтенд отображает только массив `data`, игнорируя `pagination.total`

**Как исправить:**
- Вариант 1: Изменить `defaultLimit` с 20 на 100 для `/api/v1/cities`
- Вариант 2: Фронтенд должен запрашивать с `limit=100` или делать запросы на все страницы
- Вариант 3: Добавить специальный endpoint `/api/v1/cities/all` без пагинации

**Что проверить после исправления:**
- Запрос `/api/v1/cities?limit=100` должен возвращать все 30 городов
- `pagination.total` должен быть 30
- `data.length` должен быть 30 при `limit=100`

---

### ⚠️ ПРОБЛЕМА #2: Отсутствие городов Чурапча, Амга, Томмот в unified reference

**Файл:** `backend/data/mock/yakutia-cities-reference.json`  
**Строки:** 1-139

**Причина проблемы:**
- В справочнике `yakutia-cities-reference.json` содержится только 16 городов
- Города **Чурапча**, **Амга**, **Томмот** отсутствуют в справочнике
- Эти города не могут появиться в ответе API, так как их нет в unified reference

**Текущий список городов в yakutia-cities-reference.json:**
1. Якутск ✅
2. Мирный ✅
3. Нерюнгри ✅
4. Ленск ✅
5. Вилюйск ✅
6. Олёкминск ✅
7. Тикси ✅
8. Алдан ✅
9. Хандыга ✅
10. Покровск ✅
11. Удачный ✅
12. Верхоянск ✅
13. Жиганск ✅
14. Среднеколымск ✅
15. Чокурдах ✅
16. Бестях ✅

**Отсутствуют:**
- ❌ Чурапча
- ❌ Амга
- ❌ Томмот

**Как воспроизвести:**
1. Проверить `backend/data/mock/yakutia-cities-reference.json`
2. Убедиться, что Чурапча, Амга, Томмот отсутствуют
3. Запросить `/api/v1/cities?limit=100`
4. Убедиться, что эти города отсутствуют в ответе

**Почему фронтенд видит только 20 городов:**
- Если в unified reference только 30 городов (16 якутских + 14 федеральных), но пользователь ожидает 33 (включая Чурапча, Амга, Томмот), то проблема в том, что этих городов нет в справочнике
- Если эти города должны быть добавлены в справочник, их нужно добавить

**Как исправить:**
- Добавить города Чурапча, Амга, Томмот в `yakutia-cities-reference.json`
- После добавления перезапустить pipeline для создания virtual stops для этих городов

**Что проверить после исправления:**
- Проверить, что в unified reference теперь 33 города (или нужное количество)
- Проверить, что virtual stops созданы для новых городов
- Проверить, что все города появляются в `/api/v1/cities?limit=100`

---

### ✅ ИСПРАВЛЕНО: Логическая ошибка в проверке missingFromStops

**Файл:** `backend/src/presentation/controllers/CitiesController.ts`  
**Строки:** 256-326

**Статус:** ✅ Исправлено в предыдущих коммитах

**Что было исправлено:**
- Создан snapshot `citiesSetBeforeFinal` ДО финального шага
- Проверка `missingFromStops` теперь выполняется относительно snapshot
- Добавлено детальное логирование

---

### ✅ ИСПРАВЛЕНО: Отсутствие проверки на пустой unified reference

**Файл:** `backend/src/presentation/controllers/CitiesController.ts`  
**Строки:** 262-267

**Статус:** ✅ Исправлено в предыдущих коммитах

**Что было исправлено:**
- Добавлена проверка `if (!allUnifiedCities || allUnifiedCities.length === 0)`
- Добавлено логирование ошибки, если unified reference пустой

---

### ✅ ИСПРАВЛЕНО: Кэширование пустого Map при ошибке

**Файл:** `backend/src/shared/utils/unified-cities-loader.ts`  
**Строки:** 122-129

**Статус:** ✅ Исправлено в предыдущих коммитах

**Что было исправлено:**
- Кэширование происходит только если `citiesMap.size > 0`
- Если Map пустой, кэш не сохраняется, что позволяет повторить попытку

---

## Анализ каждого слоя системы

### CitiesController.ts

**Финальный шаг (строки 254-326):**
- ✅ Финальный шаг выполняется всегда (внутри try-catch)
- ✅ Snapshot `citiesSetBeforeFinal` формируется правильно (строка 256)
- ✅ Все города из unified reference добавляются в `citiesSet` (строки 278-284)
- ✅ Проверка `normalizedCitiesMap.has` не пропускает города (строка 189, 243)
- ✅ Финальный шаг выполняется всегда, даже если unified reference пустой (есть fallback)
- ✅ Try/catch не проглатывает ошибки (строки 319-325)
- ✅ `pagination.total` основан на полном списке городов (строка 332: `total = cities.length`)
- ⚠️ `limit=20` по умолчанию (строка 331) - это проблема для фронтенда

**Обработка реальных остановок (строки 143-194):**
- ✅ Города извлекаются из `stop.cityId` или `stop.name`
- ✅ Проверяется наличие в unified reference (строки 153, 177)
- ✅ Если город не найден в unified reference, он пропускается (строки 157-158, 183)
- ✅ Города добавляются в `citiesSet` только если они в unified reference

**Обработка виртуальных остановок (строки 197-248):**
- ✅ Аналогичная логика к реальным остановкам
- ✅ Города извлекаются из `stop.cityId` или `stop.name`
- ✅ Проверяется наличие в unified reference

**Финальная верификация (строки 337-368):**
- ✅ Сравнивается полный список городов (до пагинации) с unified reference
- ✅ Логируется количество пропущенных городов

---

### unified-cities-loader.ts

**Загрузка unified reference (строки 61-140):**
- ✅ Загружаются якутские города (строки 69-83)
- ✅ Загружаются федеральные города (строки 85-111)
- ✅ Кэширование происходит только если Map не пустой (строки 123-129)
- ✅ Кэш не сохраняется при ошибке (строка 135)
- ✅ Файл содержит ровно 30 городов (16 якутских + 14 федеральных)

**Проблема:**
- ❌ В справочнике отсутствуют города: Чурапча, Амга, Томмот

---

### VirtualEntitiesGeneratorWorker.ts

**Создание виртуальных остановок (строки 305-369):**
- ✅ Поиск городов по нормализованному и оригинальному названиям (строки 313-336)
- ✅ Виртуальные остановки создаются для всех missing cities (строки 143-149)
- ✅ Статистика: missing yakutia, missing federal (строки 154-164)
- ✅ `cityId` у виртуальных стопов берётся из unified reference (строка 352: `normalizeCityName(city.name)`)

**Проблема:**
- ⚠️ Если города нет в unified reference, виртуальная остановка не создаётся (строки 326-329)
- Это означает, что для Чурапча, Амга, Томмот виртуальные остановки не будут созданы, так как их нет в unified reference

---

### ODataSyncWorker.ts

**Маппинг городов (строки 273-386):**
- ✅ Города извлекаются из названий остановок (строки 281-284)
- ✅ Suburbs и airport-to-city маппинг работает (строки 286-302)
- ✅ Все `cityName` приводятся к unified reference (строки 309-332)
- ✅ City mapping statistics логируются (строки 266-271, 390)

**Проблема:**
- ⚠️ Если город не в unified reference, остановка пропускается (строки 352-359)
- Это означает, что остановки для Чурапча, Амга, Томмот будут пропущены, если их нет в unified reference

---

### GraphBuilderWorker.ts

**Список уникальных cityId (строки 230-286):**
- ✅ Все cityId нормализуются (строки 237, 243)
- ✅ Проверяется, что все 30 городов присутствуют среди cityId (строки 248-251)
- ✅ Transfer edges и ferry edges проверяются (строки 349-374)
- ✅ Логируется количество пропущенных городов (строки 265-277)

**Проблема:**
- ⚠️ Если города нет в unified reference, он не попадает в граф (строки 570-576 в `filterInvalidStops`)
- Это означает, что для Чурапча, Амга, Томмот не будет узлов в графе, если их нет в unified reference

---

### База данных PostgreSQL

**Проверка:**
- Нужно проверить: `SELECT DISTINCT city_id FROM stops;`
- Нужно проверить: `SELECT DISTINCT city_id FROM virtual_stops;`
- Нужно проверить: `SELECT count(*) FROM stops;`
- Нужно проверить: `SELECT count(*) FROM routes;`

**Ожидаемый результат:**
- В `stops` и `virtual_stops` должны быть city_id для всех 30 городов из unified reference
- Если городов больше 30 (после добавления Чурапча, Амга, Томмот), их city_id также должны быть в базе

---

### BuildRouteUseCase.optimized.ts

**Поиск остановок по cityId (строки 355-365):**
- ✅ Используется `getRealStopsByCityName` и `getVirtualStopsByCityName`
- ✅ Фильтрация виртуальных и реальных остановок работает корректно

**Проблема:**
- ⚠️ Если города нет в unified reference, остановки для него не будут найдены
- Это означает, что поиск маршрутов для Чурапча, Амга, Томмот не будет работать, если их нет в unified reference

---

## Итоговый вывод

### Где именно происходит потеря оставшихся 10 городов

**Основная причина:** Пагинация по умолчанию `limit=20`

1. **Финальный шаг работает правильно:**
   - Все 30 городов из unified reference добавляются в `citiesSet` (строка 283)
   - `cities` содержит все 30 городов (строка 328)
   - `pagination.total` = 30 (строка 332)

2. **Пагинация применяется:**
   - `limit = 20` по умолчанию (строка 331)
   - `paginatedCities` содержит только первые 20 городов (строка 335)
   - Фронтенд получает только 20 городов в массиве `data`

3. **Проблема с отсутствующими городами:**
   - Города **Чурапча**, **Амга**, **Томмот** отсутствуют в `yakutia-cities-reference.json`
   - Эти города не могут появиться в ответе API, так как их нет в unified reference
   - Если эти города должны быть в системе, их нужно добавить в справочник

---

## Список данных, которые удаляются или не используются

1. **Города из stops, которых нет в unified reference:**
   - Удаляются в `CitiesController.ts` (строки 157-158, 183, 211-212, 237)
   - Удаляются в `ODataSyncWorker.ts` (строки 352-359)
   - Удаляются в `GraphBuilderWorker.ts` (строки 570-576)

2. **Города из unified reference, для которых нет stops:**
   - Добавляются в финальном шаге `CitiesController.ts` (строки 278-284)
   - Но если города нет в unified reference, он не будет добавлен

---

## Какие города теряются и на каком этапе

1. **Чурапча, Амга, Томмот:**
   - **Этап потери:** Отсутствуют в `yakutia-cities-reference.json`
   - **Причина:** Эти города не добавлены в unified reference
   - **Решение:** Добавить эти города в справочник

2. **Города на второй странице пагинации:**
   - **Этап потери:** Пагинация в `CitiesController.ts` (строка 335)
   - **Причина:** `limit=20` по умолчанию, фронтенд не запрашивает вторую страницу
   - **Решение:** Изменить `defaultLimit` или фронтенд должен запрашивать с `limit=100`

---

## Рекомендации по исправлению

### Приоритет 1: Исправить пагинацию

**Файл:** `backend/src/presentation/controllers/CitiesController.ts`

**Изменение:**
- Изменить вызов `parsePaginationParams` для `/api/v1/cities` с `defaultLimit=100` вместо 20
- Или создать отдельный endpoint `/api/v1/cities/all` без пагинации

### Приоритет 2: Добавить отсутствующие города

**Файл:** `backend/data/mock/yakutia-cities-reference.json`

**Изменение:**
- Добавить города: Чурапча, Амга, Томмот
- После добавления перезапустить pipeline для создания virtual stops

### Приоритет 3: Проверить фронтенд

**Проверка:**
- Убедиться, что фронтенд запрашивает с `limit=100` или делает запросы на все страницы
- Убедиться, что фронтенд использует `pagination.total` для отображения общего количества городов

---

## Что проверить после исправления

1. ✅ Запрос `/api/v1/cities?limit=100` возвращает все 30+ городов
2. ✅ `pagination.total` равен количеству городов из unified reference
3. ✅ В ответе всегда минимум 30 городов при `limit=100`
4. ✅ При `limit=20` `data.length = 20`, но `pagination.total = 30`
5. ✅ Все города из unified reference присутствуют в ответе
6. ✅ Города Чурапча, Амга, Томмот присутствуют (после добавления в справочник)
7. ✅ Фронтенд отображает все города в автокомплите
8. ✅ Поиск маршрутов работает для всех направлений

---

## Таблица расхождений

| Источник | Количество | Статус |
|----------|-----------|--------|
| yakutia-cities-reference.json | 16 | ✅ |
| russia-federal-cities-reference.json | 14 | ✅ |
| unified reference (всего) | 30 | ✅ |
| citiesSet (после финального шага) | 30 | ✅ (если unified reference = 30) |
| cities (отсортированный массив) | 30 | ✅ |
| paginatedCities (page=1, limit=20) | 20 | ⚠️ Только первые 20 |
| pagination.total | 30 | ✅ |
| Ответ API (data) при limit=20 | 20 | ⚠️ Только первые 20 |
| Ответ API (data) при limit=100 | 30 | ✅ Все города |
| Ожидаемые города (включая Чурапча, Амга, Томмот) | 33 | ❌ Отсутствуют 3 города |

---

## Заключение

**Основная проблема:** Пагинация по умолчанию `limit=20` приводит к тому, что фронтенд получает только первые 20 городов из 30.

**Дополнительная проблема:** Города Чурапча, Амга, Томмот отсутствуют в unified reference, поэтому они не могут появиться в ответе API.

**Решение:**
1. Изменить `defaultLimit` для `/api/v1/cities` на 100
2. Добавить отсутствующие города в `yakutia-cities-reference.json`
3. Перезапустить pipeline для создания virtual stops для новых городов
4. Проверить, что фронтенд корректно обрабатывает пагинацию

