# Полный аудит Docker и проекта — отчёт

## Дата: 2024

## Найденные проблемы

### 1. Docker Compose

#### 1.1. Дублирование start_period для MinIO
- **Проблема:** Строки 45-46 содержат дублирующийся `start_period: 30s`
- **Влияние:** Не критично, но создаёт путаницу
- **Исправление:** Удалить дубликат

#### 1.2. Redis healthcheck с переменной окружения
- **Проблема:** Healthcheck использует `${REDIS_PASSWORD:-123456S}` в команде
- **Влияние:** Может не работать корректно, если переменная не подставится
- **Исправление:** Использовать фиксированное значение или другой подход

#### 1.3. Postgres healthcheck с переменной окружения
- **Проблема:** Healthcheck использует переменные окружения в команде
- **Влияние:** Может не работать, если переменные не подставятся
- **Исправление:** Использовать фиксированные значения или другой подход

### 2. Backend Dockerfile

#### 2.1. Production stage копирует все node_modules
- **Проблема:** Production stage копирует все node_modules из deps, включая devDependencies
- **Влияние:** Увеличенный размер production образа, больше уязвимостей
- **Исправление:** Создать отдельный stage для production dependencies

#### 2.2. Нет оптимизации для production dependencies
- **Проблема:** Нет отдельной установки только production зависимостей
- **Влияние:** Больший размер образа, медленнее запуск
- **Исправление:** Добавить stage `deps-prod` с `npm ci --only=production`

### 3. Backend package.json

#### 3.1. Неправильная версия Zod
- **Проблема:** `zod: ^4.1.12` — такой версии не существует (последняя 3.x)
- **Влияние:** Может вызвать проблемы при установке или использовании
- **Исправление:** Изменить на `^3.25.76` (как во frontend)

### 4. Frontend Dockerfile

#### 4.1. Порядок копирования файлов можно оптимизировать
- **Проблема:** Все файлы копируются сразу, что уменьшает эффективность кэширования
- **Влияние:** Медленнее пересборки при изменении только части файлов
- **Исправление:** Оптимизировать порядок копирования (сначала конфиги, потом src)

### 5. .dockerignore

#### 5.1. Дублирование паттернов в backend/.dockerignore
- **Проблема:** Некоторые паттерны дублируются (например, `*.tsbuildinfo`, `*.swp`)
- **Влияние:** Не критично, но создаёт путаницу
- **Исправление:** Удалить дубликаты

## План исправлений

### Приоритет 1 (Критично)

1. Исправить версию Zod в backend/package.json
2. Оптимизировать backend/Dockerfile для production (отдельные production dependencies)
3. Удалить дубликат start_period в docker-compose.yml

### Приоритет 2 (Важно)

4. Исправить healthchecks в docker-compose.yml (убрать переменные из команд)
5. Оптимизировать порядок копирования в frontend/Dockerfile
6. Очистить дубликаты в .dockerignore

### Приоритет 3 (Оптимизация)

7. Добавить больше кэширования в Dockerfile'ы
8. Оптимизировать размер образов


