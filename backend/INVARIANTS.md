# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2024-12-19  
**–¶–µ–ª—å:** –î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï–õ–¨–ó–Ø –ª–æ–º–∞—Ç—å –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Å–∏—Å—Ç–µ–º–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.

**–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã:** `PRODUCTION_EXECUTION_LOG.md` (—Ä–∞–∑–¥–µ–ª "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã 'No stops found for city'")

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã (–ù–ï–õ–¨–ó–Ø –õ–û–ú–ê–¢–¨)

### 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `date` –≤ –ø–æ–∏—Å–∫–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** –ü–∞—Ä–∞–º–µ—Ç—Ä `date` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –ø–æ–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ (`/api/v1/routes/search`, `/api/v1/routes/build`) **–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω**.

**–§–∞–π–ª—ã:**
- `backend/src/presentation/validators/route.validator.ts`:
  - `routeSearchSchema.date` ‚Üí `.optional()`
  - `routeBuildSchema.date` ‚Üí `.optional()`

**–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:**
- `backend/src/presentation/controllers/RouteBuilderController.ts`:
  - `buildRoute()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `dateStr ? new Date(dateStr) : new Date()` (–¥–µ—Ñ–æ–ª—Ç = —Å–µ–≥–æ–¥–Ω—è)

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- Frontend –º–æ–∂–µ—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `date` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –≤ —Å—Ö–µ–º–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
- –ï—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å `date` –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º ‚Üí frontend –±—É–¥–µ—Ç –ø–æ–ª—É—á–∞—Ç—å 400 –æ—à–∏–±–∫–∏
- –≠—Ç–æ —É–∂–µ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ `PRODUCTION_EXECUTION_LOG.md`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, '...').optional()

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, '...') // –±–µ–∑ .optional()
```

---

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ –≤ Redis —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ë–î

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** –ì—Ä–∞—Ñ –≤ Redis **–î–û–õ–ñ–ï–ù** —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º –≤ PostgreSQL.

**–ü—Ä–æ–±–ª–µ–º–∞ (–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è):**
- –ì—Ä–∞—Ñ —Å—Ç—Ä–æ–∏–ª—Å—è –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (12 nodes, 14 edges)
- –ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–û–ª–µ–∫–º–∏–Ω—Å–∫, –õ–µ–Ω—Å–∫) –¥–æ–±–∞–≤–ª—è–ª–∏—Å—å –≤ –º–æ–∫-—Ñ–∞–π–ª—ã
- –ì—Ä–∞—Ñ –Ω–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Üí —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ—à–∏–±–∫–∞ "No stops found for city" (—Ö–æ—Ç—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±—ã–ª–∏ –≤ –ë–î)

**–ú–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏:**
- Endpoint: `POST /api/v1/admin/rebuild-graph` (—Ç–æ–ª—å–∫–æ dev-—Ä–µ–∂–∏–º)
- –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π pipeline: ODataSync ‚Üí VirtualEntities ‚Üí GraphBuilder
- –§–∞–π–ª: `backend/src/presentation/controllers/GraphRebuildController.ts`

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏:**
- –ú–æ–¥—É–ª—å: `backend/src/infrastructure/startup/GraphConsistencyCheck.ts`
- –í–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑: `ENABLE_GRAPH_CONSISTENCY_CHECK=true`
- –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –≤ –ë–î vs nodes –≤ –≥—Ä–∞—Ñ–µ, —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –ï—Å–ª–∏ –≥—Ä–∞—Ñ –æ—Ç—Å—Ç–∞–µ—Ç –æ—Ç –ë–î ‚Üí –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ë–î, –Ω–æ –Ω–µ –≤ –≥—Ä–∞—Ñ–µ
- –†–µ–∑—É–ª—å—Ç–∞—Ç: "No stops found for city" –∏–ª–∏ "No path found"
- –≠—Ç–æ —É–∂–µ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –≥—Ä–∞—Ñ–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–∫-–¥–∞–Ω–Ω—ã—Ö
curl -X POST http://localhost:5000/api/v1/admin/rebuild-graph
```

---

### 3. –õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –≤ `findStopsForCity()`

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** –ú–µ—Ç–æ–¥ `findStopsForCity()` –≤ `OptimizedBuildRouteUseCase` –∏—â–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:
1. –°–Ω–∞—á–∞–ª–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ `getRealStopsByCityName()`
2. –ó–∞—Ç–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ `getVirtualStopsByCityName()`
3. –ï—Å–ª–∏ –æ–±–∞ –ø–æ–∏—Å–∫–∞ –≤–µ—Ä–Ω—É–ª–∏ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ ‚Üí –æ—à–∏–±–∫–∞ "No stops found for city"

**–§–∞–π–ª:** `backend/src/application/route-builder/use-cases/BuildRouteUseCase.optimized.ts`

**–°—Ç—Ä–æ–∫–∏:** 210-222 (–º–µ—Ç–æ–¥ `findStopsForCity()`), 129-149 (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –ø–æ—è–≤–ª–µ–Ω–∏—é –æ—à–∏–±–∫–∏ "No stops found for city"
- –ü–æ—Ä—è–¥–æ–∫ –ø–æ–∏—Å–∫–∞ (—Å–Ω–∞—á–∞–ª–∞ —Ä–µ–∞–ª—å–Ω—ã–µ, –ø–æ—Ç–æ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ) –≤–∞–∂–µ–Ω –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Unit-—Ç–µ—Å—Ç—ã: `backend/src/__tests__/unit/use-cases/OptimizedBuildRouteUseCase.test.ts`
- Integration-—Ç–µ—Å—Ç—ã: `backend/src/__tests__/integration/use-cases/OptimizedBuildRouteUseCase.integration.test.ts`

---

### 4. –†–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É "No stops found" –∏ "No path found"

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–ª–∏—á–∞–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞ –æ—à–∏–±–æ–∫:

1. **"No stops found for city: {cityName}"** (—Å—Ç—Ä–æ–∫–∞ 134, 145 –≤ `BuildRouteUseCase.optimized.ts`)
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ `findStopsForCity()` –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
   - **–ü—Ä–∏—á–∏–Ω–∞:** –û—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ë–î (–Ω–∏ —Ä–µ–∞–ª—å–Ω—ã–µ, –Ω–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ)
   - **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞–∑–≤–∞–Ω–∏–π –≥–æ—Ä–æ–¥–æ–≤

2. **"No path found between {fromCity} and {toCity}"** (—Å—Ç—Ä–æ–∫–∞ 165 –≤ `BuildRouteUseCase.optimized.ts`)
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–π–¥–µ–Ω—ã, –Ω–æ –ø—É—Ç—å –≤ –≥—Ä–∞—Ñ–µ –Ω–µ –Ω–∞–π–¥–µ–Ω
   - **–ü—Ä–∏—á–∏–Ω–∞:** –û—Å—Ç–∞–Ω–æ–≤–∫–∏ –µ—Å—Ç—å –≤ –ë–î, –Ω–æ –∏—Ö –Ω–µ—Ç –≤ –≥—Ä–∞—Ñ–µ, –∏–ª–∏ –Ω–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –º–µ–∂–¥—É –Ω–∏–º–∏
   - **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä–∞—Ñ –≤ Redis, –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≥—Ä–∞—Ñ —á–µ—Ä–µ–∑ `/api/v1/admin/rebuild-graph`

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –†–∞–∑–Ω—ã–µ –æ—à–∏–±–∫–∏ —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π
- "No stops found" ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤ –ë–î
- "No path found" ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ —Å –≥—Ä–∞—Ñ–æ–º –≤ Redis –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –º–∞—Ä—à—Ä—É—Ç–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```typescript
// –í BuildRouteUseCase.optimized.ts
if (fromStops.length === 0) {
  return { error: `No stops found for city: ${request.fromCity}` }; // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
}

if (!path || path.length === 0) {
  return { error: `No path found between ${request.fromCity} and ${request.toCity}` }; // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
}
```

### 5. –ï–¥–∏–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ city_id –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ **–î–û–õ–ñ–ù–û** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é —É—Ç–∏–ª–∏—Ç—É `extractCityFromStopName()` –∏–∑ `city-normalizer.ts`.

**–§–∞–π–ª—ã:**
- `backend/src/shared/utils/city-normalizer.ts`: —Ñ—É–Ω–∫—Ü–∏—è `extractCityFromStopName()`
- `backend/src/application/workers/ODataSyncWorker.ts`: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `extractCityFromStopName()`
- `backend/src/application/route-builder/RouteGraphBuilder.ts`: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `extractCityFromStopName()`
- `backend/src/application/route-builder/use-cases/BuildRouteUseCase.optimized.ts`: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `extractCityFromStopName()`

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≥–æ—Ä–æ–¥ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö —Å–∏—Å—Ç–µ–º—ã –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–≤–æ–¥–∏—Ç—å—Å—è –∫ –æ–¥–Ω–æ–º—É –∏ —Ç–æ–º—É –∂–µ –∑–Ω–∞—á–µ–Ω–∏—é
- –†–∞–∑–Ω—ã–µ –ª–æ–≥–∏–∫–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –ï–¥–∏–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: "–ê—ç—Ä–æ–ø–æ—Ä—Ç –Ø–∫—É—Ç—Å–∫", "–ê–≤—Ç–æ—Å—Ç–∞–Ω—Ü–∏—è –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –Ø–∫—É—Ç—Å–∫", "–í–æ–∫–∑–∞–ª –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ –ú–æ—Å–∫–æ–≤—Å–∫–∏–π"

**–ü—Ä–∞–≤–∏–ª–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:**
- –î–ª—è "–¢–∏–ø –ì–æ—Ä–æ–¥" (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ê—ç—Ä–æ–ø–æ—Ä—Ç –Ø–∫—É—Ç—Å–∫") ‚Üí –±–µ—Ä–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ "–Ø–∫—É—Ç—Å–∫"
- –î–ª—è "–ì–æ—Ä–æ–¥ –¢–∏–ø" (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–Ø–∫—É—Ç—Å–∫ –ê—ç—Ä–æ–ø–æ—Ä—Ç") ‚Üí –±–µ—Ä–µ—Ç—Å—è –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ "–Ø–∫—É—Ç—Å–∫" (–µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ ‚Äî —Ç–∏–ø –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)
- –î–ª—è "–¢–∏–ø –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ –ì–æ—Ä–æ–¥" (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ê–≤—Ç–æ—Å—Ç–∞–Ω—Ü–∏—è –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –Ø–∫—É—Ç—Å–∫") ‚Üí –±–µ—Ä–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ "–Ø–∫—É—Ç—Å–∫"
- –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–∏–ø—ã –æ—Å—Ç–∞–Ω–æ–≤–æ–∫: "–∞—ç—Ä–æ–ø–æ—Ä—Ç", "–≤–æ–∫–∑–∞–ª", "–∞–≤—Ç–æ—Å—Ç–∞–Ω—Ü–∏—è", "–æ—Å—Ç–∞–Ω–æ–≤–∫–∞", "—Å—Ç–∞–Ω—Ü–∏—è"

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é —É—Ç–∏–ª–∏—Ç—É
import { extractCityFromStopName } from '../../shared/utils/city-normalizer';
const cityName = extractCityFromStopName(stop.name, stop.address);

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ—é –ª–æ–≥–∏–∫—É –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
const cityName = stop.name.split(' ')[1]; // –∏–ª–∏ –¥—Ä—É–≥–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
```

### 6. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ—Ä–æ–¥–æ–≤

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π –≥–æ—Ä–æ–¥–æ–≤ **–î–û–õ–ñ–ù–ê** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é —É—Ç–∏–ª–∏—Ç—É `normalizeCityName()` –∏–∑ `city-normalizer.ts` –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö.

**–§–∞–π–ª—ã:**
- `backend/src/shared/utils/city-normalizer.ts`: —Ñ—É–Ω–∫—Ü–∏—è `normalizeCityName()`
- `backend/src/infrastructure/repositories/PostgresStopRepository.ts`: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞
- `backend/src/application/route-builder/RouteGraph.ts`: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ —É–∑–ª–æ–≤
- `backend/src/application/route-builder/PathFinder.ts`: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –û–¥–∏–Ω –≥–æ—Ä–æ–¥ –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–≤–æ–¥–∏—Ç—å—Å—è –∫ –æ–¥–Ω–æ–º—É –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é –≤–µ–∑–¥–µ
- –†–∞–∑–Ω—ã–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Ç–æ–º—É, —á—Ç–æ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≥–æ—Ä–æ–¥ –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —É—á–∏—Ç—ã–≤–∞–µ—Ç: —Ä–µ–≥–∏—Å—Ç—Ä, "—ë" ‚Üí "–µ", –ø—Ä–µ—Ñ–∏–∫—Å—ã ("–≥.", "–≥–æ—Ä–æ–¥")

**–ü—Ä–∞–≤–∏–ª–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:**
- –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤: "–≥. –Ø–∫—É—Ç—Å–∫" ‚Üí "—è–∫—É—Ç—Å–∫"
- –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ lowercase: "–Ø–ö–£–¢–°–ö" ‚Üí "—è–∫—É—Ç—Å–∫"
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è "—ë" ‚Üí "–µ": "–û–ª—ë–∫–º–∏–Ω—Å–∫" ‚Üí "–æ–ª–µ–∫–º–∏–Ω—Å–∫"
- –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤: "  –Ø–∫—É—Ç—Å–∫  " ‚Üí "—è–∫—É—Ç—Å–∫"

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—É—é —É—Ç–∏–ª–∏—Ç—É
import { normalizeCityName } from '../../shared/utils/city-normalizer';
const normalized = normalizeCityName(cityName);

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é
const normalized = cityName.toLowerCase().replace('—ë', '–µ'); // –Ω–µ–ø–æ–ª–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
```

---

### 5. Endpoint –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –≥—Ä–∞—Ñ–∞ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤ dev-—Ä–µ–∂–∏–º–µ

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** Endpoint `POST /api/v1/admin/rebuild-graph` **–î–û–õ–ñ–ï–ù** –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ production.

**–§–∞–π–ª:** `backend/src/presentation/controllers/GraphRebuildController.ts`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```typescript
function isDevMode(): boolean {
  return process.env.NODE_ENV !== 'production';
}

// –í rebuildGraph()
if (!isDevMode()) {
  res.status(403).json({
    error: { code: 'FORBIDDEN', message: 'Graph rebuild is only available in development mode' }
  });
  return;
}
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –≥—Ä–∞—Ñ–∞ ‚Äî —Ç—è–∂–µ–ª–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –Ω–µ –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ production
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

---

### 6. Health-checks –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 503 –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** Health-checks (`/health`, `/health/ready`) –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 503 –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (PostgreSQL, Redis) ‚Äî —ç—Ç–æ **–æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**.

**–§–∞–π–ª:** `backend/src/presentation/controllers/HealthController.ts`

**–õ–æ–≥–∏–∫–∞:**
- `/health/live` ‚Üí –≤—Å–µ–≥–¥–∞ 200 (—Å–µ—Ä–≤–∏—Å –∂–∏–≤, –µ—Å–ª–∏ –æ—Ç–≤–µ—á–∞–µ—Ç)
- `/health/ready` ‚Üí 200 –µ—Å–ª–∏ –ë–î –∏ Redis –¥–æ—Å—Ç—É–ø–Ω—ã, –∏–Ω–∞—á–µ 503
- `/health` ‚Üí 200 –µ—Å–ª–∏ –≤—Å–µ –æ–∫, 503 –µ—Å–ª–∏ –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –≠—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (Kubernetes, Docker Swarm)
- –ù–µ –Ω—É–∂–Ω–æ "–∏—Å–ø—Ä–∞–≤–ª—è—Ç—å" 503 ‚Üí —ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å –¥–ª—è readiness probe

---

### 7. –ü—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤

**–ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç:** –ü—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–∏—Å–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ —Å–ª–µ–¥—É—é—â–∏–π:

```
RouteBuilderController.searchRoute()
  ‚Üí OptimizedBuildRouteUseCase.execute()
    ‚Üí findStopsForCity() [–ø–æ–∏—Å–∫ –≤ –ë–î]
    ‚Üí findShortestPath() [–ø–æ–∏—Å–∫ –≤ –≥—Ä–∞—Ñ–µ Redis]
    ‚Üí buildRouteFromPath()
```

**–§–∞–π–ª—ã:**
- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä: `backend/src/presentation/controllers/RouteBuilderController.ts`
- Use Case: `backend/src/application/route-builder/use-cases/BuildRouteUseCase.optimized.ts`
- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏: `PostgresStopRepository`, `PostgresGraphRepository`

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—É—Ç–∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –ë–î –∏ –≥—Ä–∞—Ñ–æ–º
- –ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –∏–¥–µ—Ç –≤ –ë–î, –ø–æ–∏—Å–∫ –ø—É—Ç–∏ ‚Äî –≤ –≥—Ä–∞—Ñ–µ

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

–ü–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏, –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—â–∏–º–∏:
- `OptimizedBuildRouteUseCase` –∏ `findStopsForCity()`
- `StopRepository` –∏ `RouteRepository`
- `GraphBuilder`, –≤–æ—Ä–∫–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –≥—Ä–∞—Ñ–∞
- –ú–∞—Ä—à—Ä—É—Ç—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π –≥—Ä–∞—Ñ–∞ –∏ health-check'–∞–º–∏

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**

1. ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä `date` –æ—Å—Ç–∞–µ—Ç—Å—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏?
2. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ª–æ–º–∞—é—Ç –ª–æ–≥–∏–∫—É `findStopsForCity()`?
3. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ë–î ‚Üî Redis?
4. ‚úÖ Endpoint –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –≥—Ä–∞—Ñ–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞—â–∏—â–µ–Ω–Ω—ã–º (—Ç–æ–ª—å–∫–æ dev)?
5. ‚úÖ Health-checks –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ?
6. ‚úÖ –†–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É "No stops found" –∏ "No path found" —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è?
7. ‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π?
8. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ (`PRODUCTION_EXECUTION_LOG.md`)?

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç "No stops found for city: {cityName}"

**–®–∞–≥ 1:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
```sql
SELECT * FROM stops WHERE city_id ILIKE '%{cityName}%' OR name ILIKE '%{cityName}%';
```

**–®–∞–≥ 2:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –Ω–∞–∑–≤–∞–Ω–∏–π
- –†–µ–≥–∏—Å—Ç—Ä: "–û–ª–µ–∫–º–∏–Ω—Å–∫" vs "–æ–ª—ë–∫–º–∏–Ω—Å–∫"
- "—ë" vs "–µ": "–û–ª—ë–∫–º–∏–Ω—Å–∫" vs "–û–ª–µ–∫–º–∏–Ω—Å–∫"
- –ü—Ä–æ–±–µ–ª—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã

**–®–∞–≥ 3:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –≥—Ä–∞—Ñ–µ
```bash
# –ß–µ—Ä–µ–∑ endpoint –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –≥—Ä–∞—Ñ–∞
GET /api/v1/routes/graph/diagnostics
```

**–®–∞–≥ 4:** –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≥—Ä–∞—Ñ (–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ –ë–î, –Ω–æ –Ω–µ—Ç –≤ –≥—Ä–∞—Ñ–µ)
```bash
POST /api/v1/admin/rebuild-graph
```

### –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç "No path found between {fromCity} and {toCity}"

**–®–∞–≥ 1:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–π–¥–µ–Ω—ã (–Ω–µ "No stops found")
- –ï—Å–ª–∏ "No stops found" ‚Üí —Å–º. –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤—ã—à–µ

**–®–∞–≥ 2:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥—Ä–∞—Ñ –≤ Redis
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ nodes –≤ –≥—Ä–∞—Ñ–µ vs –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –≤ –ë–î
- –ï—Å—Ç—å –ª–∏ –Ω—É–∂–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –≥—Ä–∞—Ñ–µ

**–®–∞–≥ 3:** –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≥—Ä–∞—Ñ
```bash
POST /api/v1/admin/rebuild-graph
```

**–®–∞–≥ 4:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –º–∞—Ä—à—Ä—É—Ç—ã –º–µ–∂–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏ –≤ –ë–î
```sql
SELECT * FROM routes WHERE from_stop_id = '{stopId}' AND to_stop_id = '{stopId}';
```

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `PRODUCTION_EXECUTION_LOG.md` ‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏ —Ä–µ—à–µ–Ω–∏–π
- `TESTING_IMPROVEMENT_PLAN.md` ‚Äî –ø–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- `DEPENDENCY_UPDATE_PLAN.md` ‚Äî –ø–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2024-12-19  
**–°–ª–µ–¥—É—é—â–∏–π –ø–µ—Ä–µ—Å–º–æ—Ç—Ä:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

