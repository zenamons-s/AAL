# Политика хранения данных в MinIO

## 1. Общие принципы

### 1.1 Назначение MinIO
- Хранение статических файлов (изображения, иконки)
- S3-совместимое хранилище
- Публичный и приватный доступ к файлам

### 1.2 Структура Bucket
**Bucket:** `travel-app`

**Типы файлов:**
- Иконки (PNG, SVG)
- Изображения (JPEG, PNG, WebP)
- Будущее: документы, видео

## 2. Структура папок

### 2.1 Иконки (`icons/`)

**Назначение:** Иконки для UI элементов

**Структура:**
```
icons/
├── transport/
│   ├── airplane.png
│   ├── train.png
│   ├── ship.png
│   └── bus.png
├── attractions/
│   ├── monument.png
│   ├── museum.png
│   ├── park.png
│   └── nature.png
├── events/
│   ├── festival.png
│   ├── concert.png
│   ├── exhibition.png
│   └── sports.png
└── weather/
    ├── sunny.png
    ├── cloudy.png
    ├── rain.png
    ├── snow.png
    └── storm.png
```

**Правила:**
- Формат: PNG, SVG
- Размер: до 1 MB
- Публичный доступ: Да
- Кэширование: Да (долгосрочное)

---

### 2.2 Изображения городов (`images/cities/`)

**Назначение:** Изображения городов

**Структура:**
```
images/cities/
├── yakutsk.jpg
├── moscow.jpg
├── saint-petersburg.jpg
└── ...
```

**Правила:**
- Формат: JPEG, PNG, WebP
- Размер: до 5 MB
- Разрешение: рекомендуется 1920x1080
- Публичный доступ: Да
- Кэширование: Да (долгосрочное)

**Именование:**
- Использовать kebab-case
- Пример: `yakutsk.jpg`, `saint-petersburg.jpg`

---

### 2.3 Изображения достопримечательностей (`images/attractions/`)

**Назначение:** Изображения достопримечательностей

**Структура:**
```
images/attractions/
├── mammoth.jpg
├── mammoth-1.jpg
├── mammoth-2.jpg
├── museum-history.jpg
└── ...
```

**Правила:**
- Формат: JPEG, PNG, WebP
- Размер: до 10 MB
- Разрешение: рекомендуется 1920x1080
- Публичный доступ: Да
- Кэширование: Да (долгосрочное)

**Именование:**
- Основное изображение: `{attraction-name}.jpg`
- Дополнительные: `{attraction-name}-{number}.jpg`
- Пример: `mammoth.jpg`, `mammoth-1.jpg`

---

### 2.4 Изображения событий (`images/events/`)

**Назначение:** Изображения событий

**Структура:**
```
images/events/
├── aurora-festival.jpg
├── winter-games.jpg
├── music-concert.jpg
└── ...
```

**Правила:**
- Формат: JPEG, PNG, WebP
- Размер: до 10 MB
- Разрешение: рекомендуется 1920x1080
- Публичный доступ: Да
- Кэширование: Да (долгосрочное)

**Именование:**
- Использовать kebab-case
- Пример: `aurora-festival.jpg`

---

### 2.5 Изображения гостиниц (`images/hotels/`)

**Назначение:** Изображения гостиниц

**Структура:**
```
images/hotels/
├── polar-star.jpg
├── arctic-hotel.jpg
└── ...
```

**Правила:**
- Формат: JPEG, PNG, WebP
- Размер: до 10 MB
- Разрешение: рекомендуется 1920x1080
- Публичный доступ: Да
- Кэширование: Да (долгосрочное)

**Именование:**
- Использовать kebab-case
- Пример: `polar-star.jpg`

---

### 2.6 Изображения автомобилей (`images/cars/`)

**Назначение:** Изображения автомобилей для аренды

**Структура:**
```
images/cars/
├── toyota-camry.jpg
├── bmw-x5.jpg
└── ...
```

**Правила:**
- Формат: JPEG, PNG, WebP
- Размер: до 5 MB
- Разрешение: рекомендуется 1280x720
- Публичный доступ: Да
- Кэширование: Да (долгосрочное)

**Именование:**
- Использовать kebab-case
- Пример: `toyota-camry.jpg`

---

### 2.7 Изображения пользователей (`images/users/`)

**Назначение:** Аватары пользователей

**Структура:**
```
images/users/
├── avatar-{userId}.jpg
├── avatar-{userId}.png
└── ...
```

**Правила:**
- Формат: JPEG, PNG, WebP
- Размер: до 5 MB
- Разрешение: рекомендуется 512x512 (квадрат)
- Публичный доступ: Нет (приватный)
- Кэширование: Да (среднесрочное)

**Именование:**
- Формат: `avatar-{userId}.{ext}`
- Пример: `avatar-123e4567-e89b-12d3-a456-426614174000.jpg`

**Доступ:**
- Только для владельца аватара
- Backend проверяет права доступа перед отдачей файла

---

## 3. Правила доступа

### 3.1 Публичный доступ

**Папки с публичным доступом:**
- `icons/` — все файлы
- `images/cities/` — все файлы
- `images/attractions/` — все файлы
- `images/events/` — все файлы
- `images/hotels/` — все файлы
- `images/cars/` — все файлы

**Настройка:**
- Bucket policy: публичный read доступ
- CORS: разрешен доступ с домена Frontend

---

### 3.2 Приватный доступ

**Папки с приватным доступом:**
- `images/users/` — только для владельца

**Настройка:**
- Bucket policy: приватный доступ
- Backend генерирует presigned URL для доступа
- Проверка прав доступа на Backend

**Генерация presigned URL:**
1. Frontend запрашивает аватар пользователя
2. Backend проверяет права доступа
3. Backend генерирует presigned URL (срок действия: 1 час)
4. Backend возвращает presigned URL
5. Frontend использует presigned URL для загрузки изображения

---

## 4. Загрузка файлов

### 4.1 Загрузка через Backend

**Процесс:**
1. Frontend отправляет файл на Backend
2. Backend валидирует файл:
   - Формат
   - Размер
   - Разрешение (если необходимо)
3. Backend загружает файл в MinIO
4. Backend получает URL файла
5. Backend сохраняет URL в PostgreSQL (если необходимо)
6. Backend возвращает URL файла

**Endpoints:**
- `POST /api/v1/users/profile/avatar` — загрузка аватара

---

### 4.2 Валидация файлов

**Правила валидации:**

**Иконки:**
- Формат: PNG, SVG
- Размер: до 1 MB
- Разрешение: до 256x256

**Изображения:**
- Формат: JPEG, PNG, WebP
- Размер: до 10 MB (города, достопримечательности, события, гостиницы), до 5 MB (автомобили, аватары)
- Разрешение: рекомендуется 1920x1080 (кроме аватаров: 512x512)

**Ошибки:**
- `400` — Неверный формат файла
- `400` — Файл слишком большой
- `400` — Неверное разрешение

---

## 5. Оптимизация изображений

### 5.1 Сжатие
- JPEG: качество 85%
- PNG: оптимизация (pngquant)
- WebP: качество 85%

### 5.2 Ресайз
- Большие изображения ресайзятся до рекомендуемого разрешения
- Сохранение пропорций

### 5.3 Thumbnails (будущее)
- Генерация миниатюр для списков
- Папка: `images/{category}/thumbnails/`

---

## 6. Кэширование

### 6.1 Настройка кэширования

**Публичные файлы:**
- Cache-Control: `public, max-age=31536000` (1 год)
- ETag: для проверки изменений

**Приватные файлы:**
- Cache-Control: `private, max-age=3600` (1 час)
- Presigned URL с ограниченным сроком действия

---

## 7. Безопасность

### 7.1 Защита от переполнения
- Ограничение размера файла
- Ограничение количества файлов на пользователя
- Мониторинг использования хранилища

### 7.2 Защита от вредоносных файлов
- Проверка MIME типа
- Сканирование на вирусы (будущее)
- Ограничение типов файлов

### 7.3 Защита от перебора
- Rate limiting для загрузки файлов
- Ограничение количества запросов на пользователя

---

## 8. Мониторинг

### 8.1 Метрики
- Размер хранилища
- Количество файлов
- Использование по папкам
- Популярные файлы

### 8.2 Логирование
- Загрузка файлов
- Удаление файлов
- Ошибки доступа

---

## 9. Резервное копирование

### 9.1 Стратегия
- Ежедневное резервное копирование
- Хранение резервных копий в отдельном bucket
- Период хранения: 30 дней

### 9.2 Восстановление
- Восстановление из резервной копии
- Восстановление отдельных файлов

---

## 10. Миграция данных

### 10.1 Инициализация
- Создание bucket при первом запуске
- Загрузка начальных иконок и изображений
- Настройка bucket policy

### 10.2 Обновление
- Добавление новых папок при необходимости
- Миграция файлов при изменении структуры

---

## 11. Будущие улучшения

### 11.1 CDN
- Интеграция с CDN для быстрой доставки файлов
- Географическое распределение

### 11.2 Автоматическая оптимизация
- Автоматическое сжатие при загрузке
- Автоматическая генерация thumbnails

### 11.3 Версионирование
- Версионирование файлов
- Откат к предыдущим версиям

### 11.4 Watermarking
- Автоматическое добавление водяных знаков
- Защита авторских прав


