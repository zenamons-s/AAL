# Архитектура карты

## 1. Общие принципы

### 1.1 Назначение карты
- Отображение маршрутов между городами
- Показ достопримечательностей вдоль маршрута
- Показ событий в городах маршрута
- Визуализация типа транспорта

### 1.2 Технологии
- **Карта:** Leaflet или Google Maps API
- **Данные маршрута:** Polyline (encoded)
- **Координаты:** WGS84 (lat, lng)

## 2. Структура данных карты

### 2.1 Данные маршрута

**Источник:** `routes.json` → поле `mapData`

**Структура:**
```json
{
  "mapData": {
    "polyline": "encoded_polyline_string",
    "waypoints": [
      {"lat": 62.0278, "lng": 129.7317, "name": "Якутск"},
      {"lat": 55.7558, "lng": 37.6173, "name": "Москва"}
    ]
  }
}
```

**Поля:**
- `polyline` — Encoded polyline для отображения линии маршрута
- `waypoints` — Точки маршрута (отправление, назначение, промежуточные)

---

### 2.2 Достопримечательности

**Источник:** `attractions.json`

**Фильтрация:**
- По координатам маршрута (в пределах буфера)
- По городу (если указан `cityId`)

**Структура для карты:**
```json
{
  "id": "attraction-uuid",
  "name": "Памятник мамонту",
  "coordinates": {"lat": 62.0278, "lng": 129.7317},
  "category": "monument",
  "iconUrl": "http://minio:9000/bucket/icons/attractions/monument.png",
  "imageUrl": "http://minio:9000/bucket/images/attractions/mammoth.jpg"
}
```

---

### 2.3 События

**Источник:** `events.json`

**Фильтрация:**
- По координатам маршрута (в пределах буфера)
- По дате (если указана дата поездки)
- По городу (если указан `cityId`)

**Структура для карты:**
```json
{
  "id": "event-uuid",
  "name": "Фестиваль северного сияния",
  "coordinates": {"lat": 62.0278, "lng": 129.7317},
  "date": "2024-01-25T18:00:00Z",
  "category": "festival",
  "iconUrl": "http://minio:9000/bucket/icons/events/festival.png",
  "imageUrl": "http://minio:9000/bucket/images/events/aurora-festival.jpg"
}
```

---

## 3. Слои карты

### 3.1 Базовый слой
**Назначение:** Основа карты

**Варианты:**
- OpenStreetMap (по умолчанию)
- Google Maps (если доступен API ключ)
- Яндекс.Карты (если доступен API ключ)

---

### 3.2 Слой маршрута
**Назначение:** Отображение маршрута

**Элементы:**
- **Polyline** — линия маршрута
- **Waypoints** — точки маршрута (маркеры)
- **Тип транспорта** — цвет линии в зависимости от типа

**Цвета линий:**
- **Самолет** — синий (#0066CC)
- **Поезд** — зеленый (#00CC66)
- **Автобус** — оранжевый (#FF9900)
- **Корабль** — голубой (#00CCFF)

**Маркеры:**
- **Точка отправления** — зеленый маркер
- **Точка назначения** — красный маркер
- **Промежуточные точки** — серый маркер

---

### 3.3 Слой достопримечательностей
**Назначение:** Отображение достопримечательностей

**Элементы:**
- **Иконки достопримечательностей** — на карте в координатах
- **Категории:**
  - Памятник — иконка памятника
  - Музей — иконка музея
  - Парк — иконка парка
  - Природа — иконка природы

**Интерактивность:**
- При клике на иконку показывается popup с:
  - Названием
  - Описанием
  - Изображением
  - Рейтингом
  - Кнопкой "Подробнее"

---

### 3.4 Слой событий
**Назначение:** Отображение событий

**Элементы:**
- **Иконки событий** — на карте в координатах
- **Категории:**
  - Фестиваль — иконка фестиваля
  - Концерт — иконка концерта
  - Выставка — иконка выставки
  - Спорт — иконка спорта

**Интерактивность:**
- При клике на иконку показывается popup с:
  - Названием
  - Датой и временем
  - Описанием
  - Изображением
  - Кнопкой "Подробнее"

---

## 4. Получение данных карты

### 4.1 Endpoint
**GET `/api/v1/routes/:id/map`**

**Описание:** Получение данных карты для маршрута

**Процесс:**
1. Backend получает маршрут из `routes.json` по `id`
2. Backend извлекает `mapData` (polyline, waypoints)
3. Backend фильтрует достопримечательности:
   - По координатам маршрута (в пределах буфера 50 км)
   - По городу (если указан `cityId`)
4. Backend фильтрует события:
   - По координатам маршрута (в пределах буфера 50 км)
   - По дате (если указана дата поездки)
   - По городу (если указан `cityId`)
5. Backend получает иконки и изображения из MinIO
6. Backend возвращает данные карты

**Ответ:**
```json
{
  "routeId": "route-uuid",
  "polyline": "encoded_polyline_string",
  "waypoints": [
    {"lat": 62.0278, "lng": 129.7317, "name": "Якутск"},
    {"lat": 55.7558, "lng": 37.6173, "name": "Москва"}
  ],
  "transport": {
    "type": "airplane",
    "color": "#0066CC"
  },
  "attractions": [
    {
      "id": "attraction-uuid",
      "name": "Памятник мамонту",
      "coordinates": {"lat": 62.0278, "lng": 129.7317},
      "category": "monument",
      "iconUrl": "http://minio:9000/bucket/icons/attractions/monument.png",
      "imageUrl": "http://minio:9000/bucket/images/attractions/mammoth.jpg"
    }
  ],
  "events": [
    {
      "id": "event-uuid",
      "name": "Фестиваль северного сияния",
      "coordinates": {"lat": 62.0278, "lng": 129.7317},
      "date": "2024-01-25T18:00:00Z",
      "category": "festival",
      "iconUrl": "http://minio:9000/bucket/icons/events/festival.png",
      "imageUrl": "http://minio:9000/bucket/images/events/aurora-festival.jpg"
    }
  ]
}
```

---

## 5. Отображение на карте

### 5.1 Инициализация карты

**Шаги:**
1. Frontend получает данные карты от Backend
2. Frontend инициализирует карту (Leaflet/Google Maps)
3. Frontend устанавливает центр карты (центр маршрута)
4. Frontend устанавливает zoom (чтобы весь маршрут был виден)

---

### 5.2 Отображение маршрута

**Шаги:**
1. Frontend декодирует polyline
2. Frontend создает линию маршрута (L.polyline)
3. Frontend устанавливает цвет линии в зависимости от типа транспорта
4. Frontend добавляет линию на карту
5. Frontend создает маркеры для waypoints
6. Frontend добавляет маркеры на карту

---

### 5.3 Отображение достопримечательностей

**Шаги:**
1. Frontend создает иконки для каждой достопримечательности
2. Frontend создает маркеры с иконками на координатах
3. Frontend добавляет popup с информацией о достопримечательности
4. Frontend добавляет маркеры на карту

**Иконки:**
- Загружаются из MinIO
- Кэшируются на Frontend
- Размер: 32x32 пикселя

---

### 5.4 Отображение событий

**Шаги:**
1. Frontend создает иконки для каждого события
2. Frontend создает маркеры с иконками на координатах
3. Frontend добавляет popup с информацией о событии
4. Frontend добавляет маркеры на карту

**Иконки:**
- Загружаются из MinIO
- Кэшируются на Frontend
- Размер: 32x32 пикселя

---

## 6. Подсчет расстояния

### 6.1 Методы расчета

**Для самолета:**
- **Great Circle Distance** — прямое расстояние между городами
- Формула: Haversine formula
- Единица: километры

**Для поезда/автобуса:**
- **Расстояние по дорогам** — если доступно (будущее)
- Или Great Circle Distance с коэффициентом (1.2-1.5)

**Для корабля:**
- **Расстояние по воде** — если доступно (будущее)
- Или Great Circle Distance с коэффициентом (1.1-1.3)

---

### 6.2 Отображение расстояния

**Место отображения:**
- В информации о маршруте
- В popup маршрута на карте
- Формат: "Расстояние: 4,500 км"

---

## 7. Интерактивность

### 7.1 Клик на достопримечательность

**Действия:**
1. Показывается popup с информацией
2. Показывается изображение
3. Показывается рейтинг
4. Кнопка "Подробнее" → переход на страницу достопримечательности

---

### 7.2 Клик на событие

**Действия:**
1. Показывается popup с информацией
2. Показывается дата и время
3. Показывается изображение
4. Кнопка "Подробнее" → переход на страницу события

---

### 7.3 Изменение масштаба

**Действия:**
1. Пользователь изменяет zoom карты
2. При увеличении показываются дополнительные детали
3. При уменьшении показывается общий вид маршрута

---

### 7.4 Перемещение по карте

**Действия:**
1. Пользователь перемещается по карте
2. Карта обновляется
3. Достопримечательности и события остаются видимыми в пределах видимой области

---

## 8. Производительность

### 8.1 Оптимизация загрузки

**Стратегия:**
- Ленивая загрузка данных карты
- Загрузка только видимых достопримечательностей и событий
- Кэширование данных на Frontend

---

### 8.2 Кэширование

**Кэширование:**
- Данные маршрута (React Query)
- Иконки и изображения (браузерный кэш)
- Polyline (декодирование один раз)

---

### 8.3 Виртуализация маркеров

**Стратегия:**
- При большом количестве маркеров использовать кластеризацию
- Группировка близких маркеров в кластеры
- При увеличении zoom показывать отдельные маркеры

---

## 9. Адаптивность

### 9.1 Мобильные устройства

**Особенности:**
- Упрощенный интерфейс
- Увеличенные области клика
- Оптимизация для touch-жестов

---

### 9.2 Планшеты

**Особенности:**
- Полный интерфейс
- Больше места для popup
- Поддержка жестов

---

## 10. Будущие улучшения

### 10.1 3D карта
- Отображение рельефа
- 3D маркеры
- Анимация движения

### 10.2 Реальное время
- Отслеживание транспорта в реальном времени
- Обновление статуса маршрута

### 10.3 Дополнительные слои
- Погода на карте
- Трафик (для автобусов)
- Отели на карте

### 10.4 Маршрутизация
- Построение маршрута через несколько городов
- Оптимизация маршрута
- Альтернативные маршруты

