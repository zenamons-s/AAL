# Версионирование API

## 1. Общие принципы

### 1.1 Стратегия версионирования
- **URL Path Versioning** — версия в пути URL (`/api/v1/`)
- **Обратная совместимость** в рамках версии
- **Минимальный период поддержки** старой версии: 6 месяцев
- **Deprecation policy** — уведомление о устаревании

### 1.2 Текущая версия
- **Версия:** `v1`
- **Базовый путь:** `/api/v1/`

---

## 2. Правила создания новой версии

### 2.1 Когда создавать v2

**Причины:**
- Breaking changes в структуре ответов
- Удаление endpoints
- Изменение обязательных параметров
- Изменение формата данных

**НЕ создавать v2 для:**
- Добавление новых endpoints
- Добавление опциональных полей
- Исправление багов
- Улучшение производительности

---

### 2.2 Процесс создания v2

**Шаги:**
1. Создание нового пути `/api/v2/`
2. Копирование endpoints из v1
3. Внесение изменений
4. Тестирование v2
5. Документирование изменений
6. Уведомление о deprecation v1 (через 6 месяцев)

---

## 3. Политика изменений

### 3.1 Обратная совместимость

**Разрешено в рамках версии:**
- Добавление новых endpoints
- Добавление опциональных полей в ответы
- Добавление опциональных параметров запроса
- Улучшение производительности

**Запрещено в рамках версии:**
- Удаление endpoints
- Изменение обязательных полей
- Изменение типов данных
- Изменение структуры ответов

---

### 3.2 Примеры изменений

**Разрешено (v1):**
```json
// Было
{
  "user": {
    "id": "uuid",
    "email": "user@example.com"
  }
}

// Стало (добавлено опциональное поле)
{
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "phone": "+7 999 123 45 67"  // Новое опциональное поле
  }
}
```

**Запрещено (требует v2):**
```json
// Было
{
  "user": {
    "id": "uuid",
    "email": "user@example.com"
  }
}

// Стало (изменена структура)
{
  "user": {
    "id": "uuid",
    "contact": {  // Изменена структура
      "email": "user@example.com"
    }
  }
}
```

---

## 4. Deprecation Policy

### 4.1 Уведомление о deprecation

**Заголовок ответа:**
```
X-API-Deprecated: true
X-API-Deprecation-Date: 2024-07-15
X-API-Sunset-Date: 2025-01-15
```

**Поля:**
- `X-API-Deprecated` — флаг устаревания
- `X-API-Deprecation-Date` — дата объявления устаревания
- `X-API-Sunset-Date` — дата прекращения поддержки

---

### 4.2 Период deprecation

**Временная шкала:**
1. **Объявление deprecation** — уведомление в заголовках
2. **Период поддержки** — 6 месяцев
3. **Sunset** — прекращение поддержки

**Пример:**
- Deprecation: 2024-01-15
- Sunset: 2024-07-15 (6 месяцев)

---

## 5. Миграция на новую версию

### 5.1 Поддержка обеих версий

**Период миграции:**
- Поддержка v1 и v2 одновременно
- Минимальный период: 6 месяцев
- Максимальный период: 12 месяцев

---

### 5.2 Помощь в миграции

**Документация:**
- Руководство по миграции
- Примеры изменений
- Чеклист миграции
- FAQ по миграции

---

## 6. Примеры версионирования

### 6.1 v1 → v2 (Breaking Change)

**Изменение структуры ответа:**

**v1:**
```json
GET /api/v1/routes/:id
{
  "id": "uuid",
  "from": "Якутск",
  "to": "Москва",
  "price": 15000
}
```

**v2:**
```json
GET /api/v2/routes/:id
{
  "id": "uuid",
  "route": {
    "from": {
      "city": "Якутск",
      "coordinates": {...}
    },
    "to": {
      "city": "Москва",
      "coordinates": {...}
    }
  },
  "pricing": {
    "amount": 15000,
    "currency": "RUB"
  }
}
```

---

### 6.2 v1 → v2 (Добавление функциональности)

**Новый endpoint:**

**v1:**
- Нет endpoint для оценки рисков

**v2:**
```json
GET /api/v2/routes/:id/risk
{
  "riskLevel": 6,
  "factors": [...],
  "recommendations": [...]
}
```

---

## 7. Документирование версий

### 7.1 Changelog

**Формат:**
```markdown
## API v2 (2024-01-15)

### Breaking Changes
- Изменена структура ответа `/routes/:id`
- Удален endpoint `/routes/search` (заменен на `/routes`)

### New Features
- Добавлен endpoint `/routes/:id/risk`
- Добавлено поле `riskLevel` в ответ маршрута

### Deprecated
- Endpoint `/routes/search` будет удален в v3
```

---

### 7.2 OpenAPI спецификация

**Версионирование:**
- Отдельная спецификация для каждой версии
- `openapi-v1.yaml`
- `openapi-v2.yaml`

---

## 8. Тестирование версий

### 8.1 Тесты совместимости

**Требования:**
- Тесты для v1 и v2
- Проверка обратной совместимости
- Проверка новых функций

---

### 8.2 Интеграционные тесты

**Требования:**
- Тесты для всех endpoints
- Тесты для миграции данных
- Тесты для deprecation

---

## 9. Мониторинг версий

### 9.1 Метрики

**Отслеживаемые метрики:**
- Использование v1 vs v2
- Количество запросов к deprecated endpoints
- Ошибки миграции

---

### 9.2 Алерты

**Условия:**
- Высокое использование deprecated endpoints
- Ошибки в новой версии
- Проблемы с миграцией

---

## 10. Будущие улучшения

### 10.1 Semantic Versioning
- Использование семантического версионирования
- Мажорные, минорные и патч версии

### 10.2 Автоматическая миграция
- Инструменты для автоматической миграции
- Скрипты миграции данных
- Валидация миграции

