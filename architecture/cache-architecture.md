# Архитектура кеширования (Redis)

## 1. Общие принципы

### 1.1 Назначение Redis
Redis используется для:
- **Кеширования результатов запросов** — ускорение ответов API
- **Хранения пользовательских сессий** — быстрый доступ к данным сессий
- **Временного хранения черновиков** — сохранение состояния форм
- **Кеширования популярных данных** — часто запрашиваемые данные

### 1.2 Стратегия кеширования
- **Cache-Aside Pattern** — приложение проверяет кеш перед запросом к БД
- **TTL (Time To Live)** — автоматическое истечение кеша
- **Инвалидация** — принудительная очистка при обновлении данных
- **Graceful Degradation** — приложение работает даже если Redis недоступен

## 2. Структура модуля Redis

### 2.1 Компоненты

```
backend/src/infrastructure/cache/
├── RedisConnection.ts      # Singleton для подключения к Redis
├── ICacheService.ts        # Интерфейс сервиса кеширования
├── RedisCacheService.ts    # Реализация сервиса кеширования
├── CacheKeyBuilder.ts      # Построитель ключей кеша
└── index.ts                # Экспорты
```

### 2.2 RedisConnection
**Назначение:** Управление подключением к Redis

**Особенности:**
- Singleton паттерн
- Автоматическое переподключение
- Обработка ошибок
- Health check (ping)

**Методы:**
- `getInstance()` — получить экземпляр
- `connect()` — подключиться к Redis
- `ping()` — проверить соединение
- `disconnect()` — отключиться
- `isReady()` — проверить готовность

### 2.3 ICacheService
**Назначение:** Интерфейс для работы с кешем

**Методы:**
- `get<T>(key)` — получить значение
- `set<T>(key, value, ttl?)` — сохранить значение
- `delete(key)` — удалить значение
- `deleteByPattern(pattern)` — удалить по паттерну
- `exists(key)` — проверить существование
- `expire(key, ttl)` — установить TTL
- `mget<T>(keys)` — получить несколько значений
- `mset<T>(data, ttl?)` — сохранить несколько значений
- `flushAll()` — очистить весь кеш

### 2.4 RedisCacheService
**Назначение:** Реализация сервиса кеширования

**Особенности:**
- JSON сериализация/десериализация
- Обработка ошибок (graceful degradation)
- Логирование операций
- Поддержка TTL

### 2.5 CacheKeyBuilder
**Назначение:** Единообразное именование ключей

**Структура ключей:**
```
travel-app:{category}:{type}:{params}
```

**Примеры:**
- `travel-app:routes:search:moscow:yakutsk:2025-01-15`
- `travel-app:hotels:city:moscow`
- `travel-app:sessions:user:123e4567-e89b-12d3-a456-426614174000`
- `travel-app:transport:taxi:moscow:yakutsk`

## 3. Места использования кеша

### 3.1 Маршруты (Routes)

**Кешируемые данные:**
- Результаты поиска маршрутов
- Популярные маршруты
- Оптимальные маршруты
- Детали конкретного маршрута

**TTL:** 30 минут (1800 секунд)

**Ключи:**
- `travel-app:routes:search:{from}:{to}:{date}`
- `travel-app:routes:id:{routeId}`
- `travel-app:routes:popular`
- `travel-app:routes:optimal`

**Инвалидация:**
- При обновлении маршрута — удаление `routes:id:{routeId}`
- При создании нового маршрута — удаление `routes:popular` и `routes:optimal`
- При массовом обновлении — удаление всех `routes:*`

### 3.2 Гостиницы (Hotels)

**Кешируемые данные:**
- Результаты поиска гостиниц
- Гостиницы по городу
- Детали конкретной гостиницы

**TTL:** 30 минут (1800 секунд)

**Ключи:**
- `travel-app:hotels:search:{city}:{checkIn}:{checkOut}`
- `travel-app:hotels:city:{city}`
- `travel-app:hotels:id:{hotelId}`

**Инвалидация:**
- При обновлении гостиницы — удаление `hotels:id:{hotelId}` и `hotels:city:{city}`
- При массовом обновлении — удаление всех `hotels:*`

### 3.3 Транспорт (Transport)

**Кешируемые данные:**
- Результаты поиска такси
- Результаты поиска аренды авто
- Результаты поиска автобусов

**TTL:** 30 минут (1800 секунд)

**Ключи:**
- `travel-app:transport:taxi:{from}:{to}`
- `travel-app:transport:rent:{city}:{startDate}:{endDate}`
- `travel-app:transport:bus:{from}:{to}:{date}`

**Инвалидация:**
- При обновлении данных транспорта — удаление соответствующих ключей
- При массовом обновлении — удаление всех `transport:*`

### 3.4 Раздел "Путешествуйте выгодно" (Favorites)

**Кешируемые данные:**
- Лучшие цены
- Оптимальные маршруты
- Популярные места

**TTL:** 1 час (3600 секунд)

**Ключи:**
- `travel-app:favorites:best-prices`
- `travel-app:favorites:optimal-routes`
- `travel-app:favorites:popular-places`

**Инвалидация:**
- При обновлении данных — удаление соответствующих ключей
- При массовом обновлении — удаление всех `favorites:*`

### 3.5 Пользовательские сессии

**Кешируемые данные:**
- Данные сессии пользователя
- JWT токены
- Избранные маршруты
- Черновики заказов
- Состояние фильтров

**TTL:** 24 часа (86400 секунд)

**Ключи:**
- `travel-app:sessions:user:{userId}`
- `travel-app:sessions:token:{token}`
- `travel-app:sessions:{userId}:favorite-routes`
- `travel-app:sessions:{userId}:draft-order`
- `travel-app:sessions:{userId}:filters:{section}`

**Инвалидация:**
- При выходе пользователя — удаление `sessions:user:{userId}` и всех `sessions:{userId}:*`
- При истечении сессии — автоматическое удаление по TTL

## 4. Правила работы с кешем

### 4.1 Проверка перед запросом к БД

```typescript
// 1. Проверяем кеш
const cached = await cacheService.get(key);
if (cached) {
  return cached;
}

// 2. Если нет в кеше — запрашиваем из БД
const data = await database.query(...);

// 3. Сохраняем в кеш
await cacheService.set(key, data, ttl);

return data;
```

### 4.2 Инвалидация при обновлении

```typescript
// 1. Обновляем данные в БД
await database.update(...);

// 2. Инвалидируем кеш
await cacheService.delete(key);

// Или по паттерну
await cacheService.deleteByPattern('travel-app:routes:*');
```

### 4.3 Graceful Degradation

```typescript
try {
  const cached = await cacheService.get(key);
  if (cached) return cached;
} catch (error) {
  // Redis недоступен — продолжаем без кеша
  console.warn('Redis unavailable, skipping cache');
}

// Продолжаем обычную логику
const data = await database.query(...);
return data;
```

## 5. Конфигурация TTL

### 5.1 Переменные окружения

```env
REDIS_TTL_DEFAULT=3600      # 1 час (по умолчанию)
REDIS_TTL_ROUTES=1800      # 30 минут (маршруты)
REDIS_TTL_HOTELS=1800      # 30 минут (гостиницы)
REDIS_TTL_TRANSPORT=1800   # 30 минут (транспорт)
REDIS_TTL_FAVORITES=3600   # 1 час (избранное)
REDIS_TTL_SESSION=86400    # 24 часа (сессии)
```

### 5.2 Выбор TTL

**Короткий TTL (30 минут):**
- Данные, которые часто обновляются
- Результаты поиска
- Данные о доступности

**Средний TTL (1 час):**
- Популярные данные
- Статистика
- Справочники

**Длинный TTL (24 часа):**
- Пользовательские сессии
- Статические данные
- Конфигурация

## 6. Мониторинг и отладка

### 6.1 Логирование

Все операции с кешем логируются:
- Успешные операции (debug уровень)
- Ошибки (error уровень)
- Предупреждения при недоступности Redis (warn уровень)

### 6.2 Метрики (будущее)

- Hit rate (процент попаданий в кеш)
- Miss rate (процент промахов)
- Время ответа кеша
- Использование памяти Redis

### 6.3 Отладка

```bash
# Подключиться к Redis контейнеру
docker exec -it travel-app-redis redis-cli

# Проверить ключи
KEYS travel-app:*

# Получить значение
GET travel-app:routes:search:moscow:yakutsk:2025-01-15

# Проверить TTL
TTL travel-app:routes:search:moscow:yakutsk:2025-01-15

# Удалить ключ
DEL travel-app:routes:search:moscow:yakutsk:2025-01-15
```

## 7. Безопасность

### 7.1 Пароль

Redis защищен паролем через переменную окружения `REDIS_PASSWORD`.

### 7.2 Изоляция

- Redis доступен только внутри Docker сети
- Публичный порт только для разработки (опционально)

### 7.3 Данные

- Не храним чувствительные данные в кеше
- JWT токены хранятся с коротким TTL
- Пароли никогда не кешируются

## 8. Производительность

### 8.1 Оптимизация

- Использование pipeline для множественных операций
- Сериализация в JSON (быстрая, но не самая эффективная)
- Сжатие больших данных (будущее)

### 8.2 Ограничения

- Максимальный размер значения: 512MB (по умолчанию Redis)
- Рекомендуемый размер: < 1MB на ключ

## 9. Резервное копирование

### 9.1 Персистентность

- AOF (Append Only File) включен
- Автоматическое восстановление при перезапуске

### 9.2 Резервное копирование (будущее)

- Регулярные снапшоты
- Репликация на другой сервер
- Восстановление из бэкапа

## 10. Масштабирование

### 10.1 Горизонтальное масштабирование

- Redis Cluster для распределенного кеша
- Sharding по категориям данных

### 10.2 Вертикальное масштабирование

- Увеличение памяти Redis
- Оптимизация TTL
- Очистка неиспользуемых ключей

