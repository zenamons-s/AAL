# Потоки интеграции и Sequence Diagrams

## 1. Общие принципы интеграции

### 1.1 Компоненты системы
- **Frontend** — React приложение
- **Backend** — API сервер (Clean Architecture)
- **PostgreSQL** — База данных
- **MinIO** — S3-совместимое хранилище
- **Mock-файлы** — JSON файлы с данными

### 1.2 Направление запросов
```
Frontend → Backend → PostgreSQL
Frontend → Backend → MinIO
Frontend → Backend → Mock-файлы
```

## 2. Sequence Diagrams

### 2.1 Поиск маршрутов

**Сценарий:** Пользователь ищет маршрут из Якутска в Москву

```
User          Frontend          Backend          Mock Files
 |                |                 |                 |
 |--[Ввод данных]-->                 |                 |
 |                |                 |                 |
 |                |--[GET /api/v1/routes/search?from=Yakutsk&to=Moscow&date=2024-01-20]-->|
 |                |                 |                 |
 |                |                 |--[Чтение routes.json]-->|
 |                |                 |<--[Данные маршрутов]---|
 |                |                 |                 |
 |                |                 |--[Чтение cities.json]-->|
 |                |                 |<--[Данные городов]---|
 |                |                 |                 |
 |                |                 |--[Чтение MinIO: иконки транспорта]-->|
 |                |                 |<--[Иконки]---|
 |                |                 |                 |
 |                |<--[200 OK: список маршрутов]---|
 |<--[Отображение маршрутов]---|
```

**Описание:**
1. Пользователь вводит данные поиска
2. Frontend отправляет GET запрос на `/api/v1/routes/search`
3. Backend читает `routes.json` и фильтрует по параметрам
4. Backend читает `cities.json` для получения данных городов
5. Backend получает иконки транспорта из MinIO
6. Backend возвращает список маршрутов
7. Frontend отображает результаты

---

### 2.2 Создание заказа

**Сценарий:** Пользователь создает заказ с маршрутом и услугами

```
User          Frontend          Backend          PostgreSQL       Mock Files
 |                |                 |                 |                 |
 |--[Выбор маршрута и услуг]-->      |                 |                 |
 |                |                 |                 |                 |
 |                |--[POST /api/v1/orders]-->          |                 |
 |                |  {routeId, passengers, services}  |                 |
 |                |                 |                 |                 |
 |                |                 |--[Валидация JWT]-->|
 |                |                 |<--[User ID]---|
 |                |                 |                 |                 |
 |                |                 |--[Чтение routes.json]-->|
 |                |                 |<--[Данные маршрута]---|
 |                |                 |                 |                 |
 |                |                 |--[Проверка доступности]-->|
 |                |                 |                 |                 |
 |                |                 |--[INSERT INTO orders]-->|
 |                |                 |                 |                 |
 |                |                 |<--[Order ID]---|
 |                |                 |                 |                 |
 |                |                 |--[INSERT INTO order_passengers]-->|
 |                |                 |                 |                 |
 |                |                 |--[INSERT INTO order_services]-->|
 |                |                 |                 |                 |
 |                |                 |--[Расчет total_price]-->|
 |                |                 |                 |                 |
 |                |                 |--[UPDATE orders SET total_price]-->|
 |                |                 |                 |                 |
 |                |<--[201 Created: заказ создан]---|
 |<--[Отображение заказа]---|
```

**Описание:**
1. Пользователь выбирает маршрут и услуги
2. Frontend отправляет POST запрос на `/api/v1/orders`
3. Backend валидирует JWT токен и получает User ID
4. Backend читает `routes.json` для проверки маршрута
5. Backend проверяет доступность маршрута
6. Backend создает запись в `orders`
7. Backend создает записи в `order_passengers`
8. Backend создает записи в `order_services`
9. Backend рассчитывает общую стоимость
10. Backend обновляет `orders` с итоговой ценой
11. Backend возвращает созданный заказ
12. Frontend отображает заказ

---

### 2.3 Отображение карты маршрута

**Сценарий:** Пользователь открывает карту маршрута

```
User          Frontend          Backend          MinIO          Mock Files
 |                |                 |              |                 |
 |--[Открытие карты]-->              |              |                 |
 |                |                 |              |                 |
 |                |--[GET /api/v1/routes/:id/map]-->|
 |                |                 |              |                 |
 |                |                 |--[Чтение routes.json]-->|
 |                |                 |<--[mapData: polyline, waypoints]---|
 |                |                 |              |                 |
 |                |                 |--[Чтение attractions.json]-->|
 |                |                 |<--[Достопримечательности]---|
 |                |                 |              |                 |
 |                |                 |--[Чтение events.json]-->|
 |                |                 |<--[События]---|
 |                |                 |              |                 |
 |                |                 |--[GET icons/attractions/*.png]-->|
 |                |                 |              |                 |
 |                |                 |<--[Иконки достопримечательностей]---|
 |                |                 |              |                 |
 |                |                 |--[GET icons/events/*.png]-->|
 |                |                 |              |                 |
 |                |                 |<--[Иконки событий]---|
 |                |                 |              |                 |
 |                |                 |--[GET images/attractions/*.jpg]-->|
 |                |                 |              |                 |
 |                |                 |<--[Изображения достопримечательностей]---|
 |                |                 |              |                 |
 |                |<--[200 OK: данные карты]---|
 |<--[Отображение карты с маршрутом, достопримечательностями и событиями]---|
```

**Описание:**
1. Пользователь открывает карту маршрута
2. Frontend отправляет GET запрос на `/api/v1/routes/:id/map`
3. Backend читает `routes.json` и получает `mapData` (polyline, waypoints)
4. Backend читает `attractions.json` и фильтрует по координатам маршрута
5. Backend читает `events.json` и фильтрует по координатам и датам
6. Backend получает иконки достопримечательностей из MinIO
7. Backend получает иконки событий из MinIO
8. Backend получает изображения достопримечательностей из MinIO
9. Backend возвращает данные карты
10. Frontend отображает карту с маршрутом, достопримечательностями и событиями

---

### 2.4 Взаимодействие с помощником (мамонтёнком)

**Сценарий:** Пользователь задает вопрос помощнику

```
User          Frontend          Backend          Mock Files
 |                |                 |                 |
 |--[Вопрос: "Что ты знаешь о Якутске?"]-->|
 |                |                 |                 |
 |                |--[POST /api/v1/assistant/chat]-->|
 |                |  {message, context}              |
 |                |                 |                 |
 |                |                 |--[Обработка вопроса]-->|
 |                |                 |                 |
 |                |                 |--[Чтение cities.json]-->|
 |                |                 |<--[Данные о Якутске]---|
 |                |                 |                 |
 |                |                 |--[Чтение weather.json]-->|
 |                |                 |<--[Погода в Якутске]---|
 |                |                 |                 |
 |                |                 |--[Чтение attractions.json]-->|
 |                |                 |<--[Достопримечательности Якутска]---|
 |                |                 |                 |
 |                |                 |--[Генерация ответа с фактами]-->|
 |                |                 |                 |
 |                |<--[200 OK: ответ помощника]---|
 |<--[Отображение ответа с погодой, фактами, рекомендациями]---|
```

**Описание:**
1. Пользователь задает вопрос
2. Frontend отправляет POST запрос на `/api/v1/assistant/chat`
3. Backend обрабатывает вопрос и извлекает ключевые слова
4. Backend читает `cities.json` для получения информации о городе
5. Backend читает `weather.json` для получения погоды
6. Backend читает `attractions.json` для получения достопримечательностей
7. Backend генерирует ответ с фактами, погодой и рекомендациями
8. Backend возвращает ответ
9. Frontend отображает ответ помощника

---

### 2.5 Авторизация пользователя

**Сценарий:** Пользователь входит в систему

```
User          Frontend          Backend          PostgreSQL
 |                |                 |                 |
 |--[Ввод email и пароля]-->        |                 |
 |                |                 |                 |
 |                |--[POST /api/v1/auth/login]-->     |
 |                |  {email, password}                 |
 |                |                 |                 |
 |                |                 |--[SELECT * FROM users WHERE email = ?]-->|
 |                |                 |                 |                 |
 |                |                 |<--[User record]---|
 |                |                 |                 |
 |                |                 |--[Проверка password_hash]-->|
 |                |                 |                 |
 |                |                 |--[Генерация JWT токена]-->|
 |                |                 |                 |
 |                |                 |--[UPDATE users SET last_login_at]-->|
 |                |                 |                 |
 |                |<--[200 OK: user, token]---|
 |                |                 |                 |
 |                |--[Сохранение token в localStorage]-->|
 |<--[Перенаправление в ЛК]---|
```

**Описание:**
1. Пользователь вводит email и пароль
2. Frontend отправляет POST запрос на `/api/v1/auth/login`
3. Backend ищет пользователя в PostgreSQL по email
4. Backend проверяет пароль (bcrypt)
5. Backend генерирует JWT токен
6. Backend обновляет `last_login_at` в PostgreSQL
7. Backend возвращает пользователя и токен
8. Frontend сохраняет токен в localStorage
9. Frontend перенаправляет в личный кабинет

---

### 2.6 Загрузка изображения пользователя

**Сценарий:** Пользователь загружает аватар

```
User          Frontend          Backend          MinIO          PostgreSQL
 |                |                 |              |                 |
 |--[Выбор файла]-->                 |              |                 |
 |                |                 |              |                 |
 |                |--[POST /api/v1/users/profile/avatar]-->|
 |                |  FormData: file  |              |                 |
 |                |                 |              |                 |
 |                |                 |--[Валидация JWT]-->|
 |                |                 |<--[User ID]---|
 |                |                 |              |                 |
 |                |                 |--[Валидация файла]-->|
 |                |                 |              |                 |
 |                |                 |--[PUT images/users/avatar-{userId}.jpg]-->|
 |                |                 |              |                 |
 |                |                 |<--[URL файла]---|
 |                |                 |              |                 |
 |                |                 |--[UPDATE users SET avatar_url]-->|
 |                |                 |                 |                 |
 |                |<--[200 OK: обновленный профиль]---|
 |<--[Отображение нового аватара]---|
```

**Описание:**
1. Пользователь выбирает файл аватара
2. Frontend отправляет POST запрос на `/api/v1/users/profile/avatar` с FormData
3. Backend валидирует JWT токен
4. Backend валидирует файл (размер, формат)
5. Backend загружает файл в MinIO в папку `images/users/`
6. Backend получает URL файла из MinIO
7. Backend обновляет `avatar_url` в PostgreSQL
8. Backend возвращает обновленный профиль
9. Frontend отображает новый аватар

---

### 2.7 Получение списка заказов пользователя

**Сценарий:** Пользователь открывает список заказов

```
User          Frontend          Backend          PostgreSQL       Mock Files
 |                |                 |                 |                 |
 |--[Открытие списка заказов]-->    |                 |                 |
 |                |                 |                 |                 |
 |                |--[GET /api/v1/orders]-->          |                 |
 |                |                 |                 |                 |
 |                |                 |--[Валидация JWT]-->|
 |                |                 |<--[User ID]---|
 |                |                 |                 |                 |
 |                |                 |--[SELECT * FROM orders WHERE user_id = ?]-->|
 |                |                 |                 |                 |
 |                |                 |<--[Orders]---|
 |                |                 |                 |                 |
 |                |                 |--[SELECT * FROM order_passengers WHERE order_id IN (...)]-->|
 |                |                 |                 |                 |
 |                |                 |<--[Passengers]---|
 |                |                 |                 |                 |
 |                |                 |--[SELECT * FROM order_services WHERE order_id IN (...)]-->|
 |                |                 |                 |                 |
 |                |                 |<--[Services]---|
 |                |                 |                 |                 |
 |                |                 |--[Чтение routes.json для каждого route_id]-->|
 |                |                 |<--[Routes data]---|
 |                |                 |                 |                 |
 |                |                 |--[Объединение данных]-->|
 |                |                 |                 |                 |
 |                |<--[200 OK: список заказов]---|
 |<--[Отображение списка заказов]---|
```

**Описание:**
1. Пользователь открывает список заказов
2. Frontend отправляет GET запрос на `/api/v1/orders`
3. Backend валидирует JWT токен
4. Backend получает заказы из PostgreSQL по `user_id`
5. Backend получает пассажиров для каждого заказа
6. Backend получает услуги для каждого заказа
7. Backend читает `routes.json` для получения данных маршрутов
8. Backend объединяет данные
9. Backend возвращает список заказов
10. Frontend отображает список заказов

---

### 2.8 Полный процесс покупки (Booking Flow)

**Сценарий:** Полный процесс от поиска маршрута до создания заказа

```
User          Frontend          Backend          PostgreSQL       Mock Files      MinIO
 |                |                 |                 |                 |              |
 |--[1. Поиск маршрутов]-->          |                 |                 |              |
 |                |                 |                 |                 |              |
 |                |--[GET /api/v1/routes/search]-->   |                 |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Чтение routes.json]-->|         |              |
 |                |                 |<--[Маршруты]---|                 |              |
 |                |                 |                 |                 |              |
 |                |                 |--[GET icons/transport/*.png]-->   |              |
 |                |                 |                 |                 |              |
 |                |                 |<--[Иконки]---|                 |              |
 |                |                 |                 |                 |              |
 |                |<--[200 OK: список маршрутов]---|                 |              |
 |<--[2. Отображение списка маршрутов]---|                 |              |
 |                |                 |                 |                 |              |
 |--[3. Выбор маршрута]-->           |                 |                 |              |
 |                |                 |                 |                 |              |
 |                |--[GET /api/v1/routes/:id]-->      |                 |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Чтение routes.json]-->|         |              |
 |                |                 |<--[Детали маршрута]---|          |              |
 |                |                 |                 |                 |              |
 |                |<--[200 OK: детали маршрута]---|                 |              |
 |<--[4. Отображение деталей маршрута]---|                 |              |
 |                |                 |                 |                 |              |
 |--[5. Нажатие "Выбрать маршрут"]-->|                 |                 |              |
 |                |                 |                 |                 |              |
 |                |--[Проверка авторизации]-->        |                 |              |
 |                |<--[Не авторизован]---|                 |              |
 |<--[6. Форма входа/регистрации]---|                 |              |
 |                |                 |                 |                 |              |
 |--[7. Вход/Регистрация]-->         |                 |                 |              |
 |                |                 |                 |                 |              |
 |                |--[POST /api/v1/auth/login]-->      |                 |              |
 |                |                 |                 |                 |              |
 |                |                 |--[SELECT * FROM users WHERE email]-->|
 |                |                 |                 |                 |              |
 |                |                 |<--[User record]---|                 |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Проверка пароля]-->|             |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Генерация JWT]-->|               |              |
 |                |                 |                 |                 |              |
 |                |<--[200 OK: user, token]---|                 |              |
 |                |                 |                 |                 |              |
 |                |--[Сохранение token]-->              |                 |              |
 |<--[8. Авторизован, переход к форме заказа]---|                 |              |
 |                |                 |                 |                 |              |
 |--[9. Ввод данных пассажиров]-->   |                 |                 |              |
 |                |                 |                 |                 |              |
 |                |--[GET /api/v1/insurance/options]-->|                 |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Чтение insurance.json]-->|        |              |
 |                |                 |<--[Варианты страховки]---|        |              |
 |                |                 |                 |                 |              |
 |                |<--[200 OK: варианты страховки]---|                 |              |
 |                |                 |                 |                 |              |
 |                |--[GET /api/v1/premium-support/options]-->|         |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Чтение premium-support.json]-->|  |              |
 |                |                 |<--[Варианты поддержки]---|         |              |
 |                |                 |                 |                 |              |
 |                |<--[200 OK: варианты поддержки]---|                 |              |
 |<--[10. Отображение формы с услугами]---|                 |              |
 |                |                 |                 |                 |              |
 |--[11. Выбор услуг]-->             |                 |                 |              |
 |                |                 |                 |                 |              |
 |                |--[Расчет итоговой стоимости]-->    |                 |              |
 |<--[12. Отображение итоговой стоимости]---|                 |              |
 |                |                 |                 |                 |              |
 |--[13. Нажатие "Создать заказ"]--> |                 |                 |                 |              |
 |                |                 |                 |                 |              |
 |                |--[POST /api/v1/orders]-->         |                 |              |
 |                |  {routeId, passengers, services}  |                 |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Валидация JWT]-->|               |              |
 |                |                 |<--[User ID]---|                   |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Чтение routes.json]-->|          |              |
 |                |                 |<--[Данные маршрута]---|           |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Проверка доступности]-->|         |              |
 |                |                 |                 |                 |              |
 |                |                 |--[BEGIN TRANSACTION]-->|            |              |
 |                |                 |                 |                 |              |
 |                |                 |--[INSERT INTO orders]-->|           |              |
 |                |                 |                 |                 |              |
 |                |                 |<--[Order ID]---|                   |              |
 |                |                 |                 |                 |              |
 |                |                 |--[INSERT INTO order_passengers]-->|              |
 |                |                 |                 |                 |              |
 |                |                 |--[INSERT INTO order_services]-->|  |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Расчет total_price]-->|          |              |
 |                |                 |                 |                 |              |
 |                |                 |--[UPDATE orders SET total_price]-->|
 |                |                 |                 |                 |              |
 |                |                 |--[COMMIT TRANSACTION]-->|           |              |
 |                |                 |                 |                 |              |
 |                |<--[201 Created: заказ создан]---|                 |              |
 |<--[14. Отображение подтверждения заказа]---|                 |              |
 |                |                 |                 |                 |              |
 |--[15. Переход в ЛК]-->            |                 |                 |              |
 |                |                 |                 |                 |              |
 |                |--[GET /api/v1/orders]-->          |                 |              |
 |                |                 |                 |                 |              |
 |                |                 |--[SELECT * FROM orders WHERE user_id]-->|
 |                |                 |                 |                 |              |
 |                |                 |<--[Orders]---|                     |              |
 |                |                 |                 |                 |              |
 |                |                 |--[SELECT * FROM order_passengers WHERE order_id IN (...)]-->|
 |                |                 |                 |                 |              |
 |                |                 |<--[Passengers]---|                |              |
 |                |                 |                 |                 |              |
 |                |                 |--[SELECT * FROM order_services WHERE order_id IN (...)]-->|
 |                |                 |                 |                 |              |
 |                |                 |<--[Services]---|                  |              |
 |                |                 |                 |                 |              |
 |                |                 |--[Чтение routes.json для каждого route_id]-->|
 |                |                 |<--[Routes data]---|               |              |
 |                |                 |                 |                 |              |
 |                |<--[200 OK: список заказов]---|                 |              |
 |<--[16. Отображение списка заказов]---|                 |              |
```

**Описание:**
1. Пользователь ищет маршруты
2. Frontend отображает список маршрутов
3. Пользователь выбирает маршрут
4. Frontend отображает детали маршрута
5. Пользователь нажимает "Выбрать маршрут"
6. Если не авторизован, показывается форма входа
7. Пользователь входит/регистрируется
8. После авторизации переход к форме заказа
9. Пользователь вводит данные пассажиров
10. Frontend загружает варианты услуг и отображает форму
11. Пользователь выбирает услуги
12. Frontend рассчитывает и отображает итоговую стоимость
13. Пользователь нажимает "Создать заказ"
14. Backend создает заказ в транзакции
15. Frontend отображает подтверждение
16. Пользователь переходит в ЛК и видит список заказов

---

## 3. Потоки данных

### 3.1 Поток данных при поиске маршрутов
```
Mock Files (routes.json, cities.json)
    ↓
Backend (фильтрация, обогащение данными)
    ↓
MinIO (получение иконок)
    ↓
Backend (формирование ответа)
    ↓
Frontend (отображение)
```

### 3.2 Поток данных при создании заказа
```
Frontend (данные заказа)
    ↓
Backend (валидация)
    ↓
PostgreSQL (сохранение заказа)
    ↓
Mock Files (проверка маршрута)
    ↓
Backend (формирование ответа)
    ↓
Frontend (отображение заказа)
```

### 3.3 Поток данных при отображении карты
```
Mock Files (routes.json, attractions.json, events.json)
    ↓
Backend (фильтрация по координатам)
    ↓
MinIO (получение иконок и изображений)
    ↓
Backend (формирование данных карты)
    ↓
Frontend (отображение на карте)
```

---

## 4. Обработка ошибок

### 4.1 Ошибки валидации
- **Frontend:** Валидация перед отправкой
- **Backend:** Валидация входных данных
- **Ответ:** 400 Bad Request с описанием ошибок

### 4.2 Ошибки авторизации
- **Backend:** Проверка JWT токена
- **Ответ:** 401 Unauthorized

### 4.3 Ошибки доступа
- **Backend:** Проверка прав доступа
- **Ответ:** 403 Forbidden

### 4.4 Ошибки ресурсов
- **Backend:** Проверка существования ресурса
- **Ответ:** 404 Not Found

### 4.5 Ошибки сервера
- **Backend:** Логирование ошибок
- **Ответ:** 500 Internal Server Error

---

## 5. Кэширование

### 5.1 Кэширование на Frontend
- React Query для кэширования API запросов
- Кэширование изображений из MinIO
- Кэширование данных маршрутов

### 5.2 Кэширование на Backend
- Кэширование mock-данных в памяти
- Кэширование данных из MinIO (если необходимо)

---

## 6. Асинхронные операции

### 6.1 Загрузка файлов
- Асинхронная загрузка в MinIO
- Прогресс загрузки для пользователя

### 6.2 Обработка больших данных
- Пагинация для списков
- Ленивая загрузка данных карты

